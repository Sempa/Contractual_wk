theme_zebra() %>%
autofit()
#)
final_table <- data.frame(exp(ci(model1$finalModel)[2:4,1:3])) %>%
mutate(Variable = c("Addison's disease advanced HIV", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium', 'gender')) %>%
dplyr::select(Variable, Estimate, CI.lower, CI.upper)
model1 <- survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Neutrophils + Lymphocyte_count + Potassium + gender, data = model_dataset)
#)
final_table <- data.frame(exp(ci(model1$finalModel)[2:4,1:3])) %>%
mutate(Variable = c("Addison's disease advanced HIV", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium', 'gender')) %>%
dplyr::select(Variable, Estimate, CI.lower, CI.upper)
exp(ci(model1$finalModel)[2:4,1:3])
coef(model1)
confint(model1)
exp(model1)
cbind(coef(model1), confint(model1))
cbind(exp(coef(model1)), exp(confint(model1)))
#)
final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)))) %>%
mutate(Variable = c("Addison's disease advanced HIV", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium', 'gender')) %>%
dplyr::select(Variable, Estimate, CI.lower, CI.upper)
final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)))) %>%
mutate(Variable = c("Addison's disease advanced HIV", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium', 'gender'))
names(final_dataset)
names(final_table)
View(final_table)
final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)))) %>%
mutate(Variable = c("Addison's disease advanced HIV", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium', 'gender'), Adj.HR = V1)
View(final_table)
final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)))) %>%
mutate(Variable = c("Addison's disease advanced HIV", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium', 'gender'), Adj.HR = V1, `95%CI` = paste('(', `X2.5..`, ', ', `X97.5..`, ')', sep = ''))
View(final_table)
summary(model1)$coefficients[, 5]
final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)), summary(model1)$coefficients[, 5])) %>%
mutate(Variable = c("Addison's disease advanced HIV", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium', 'gender'), Adj.HR = round(V1,3), `95%CI` = paste('(', round(`X2.5..`, 5), ', ', round(`X97.5..`, 5), ')', sep = ''))
View(final_table)
summary(model1)
#)
final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)), summary(model1)$coefficients[, 5])) %>%
mutate(Variable = c("Addison's disease advanced HIV", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium', 'gender'), Adj.HR = round(V1,3), `95%CI` = paste('(', round(`X2.5..`, 5), ', ', round(`X97.5..`, 5), ')', sep = ''), `P value` = V4) %>%
dplyr::select(Variable, Adj.HR, `95%CI`, `P value`)
row.names(final_table) <- 1:length(final_table$Variable)
write.csv(final_table, 'final_table_updated.csv')
View(final_table)
#)
final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)), summary(model1)$coefficients[, 5])) %>%
mutate(Variable = c("Addison's disease", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium', 'gender'), Adj.HR = round(V1,3), `95%CI` = paste('(', round(`X2.5..`, 5), ', ', round(`X97.5..`, 5), ')', sep = ''), `P value` = V4) %>%
dplyr::select(Variable, Adj.HR, `95%CI`, `P value`)
row.names(final_table) <- 1:length(final_table$Variable)
write.csv(final_table, 'final_table_updated.csv')
unlink("analysis_file_tables_cache", recursive = TRUE)
unlink("analysis_file_tables_cache", recursive = TRUE)
styler:::style_selection()
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(results = 'asis')
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(magrittr)
library(knitr)
library(kableExtra)
library(tinytex)
library(gmodels)
library(readxl)
# library(MASS)
library(gtsummary)
library(caret)
library(leaps)
library(MASS)
library(predtools)
library(randomForest)
library(mice)
library(psfmi)
library(survival)
library(ranger)
library(ggplot2)
library(dplyr)
library(ggfortify)
library(survminer)
final_dataset <- read_csv("final_dataset.csv", show_col_types = F) %>%
mutate(addisons_disease = ifelse(`Random cortisol result` < 500 & (`Synacthen: 30 minute cortisol result`< 550 & `ACTH result`> 13.9), 1, 0)) #%>%
# dat <- final_dataset %>%
# dplyr::select(`Hospital folder number`,`Random cortisol result`, `ACTH sample drawn`, `ACTH result`, `Synacthen: 0 minute cortisol result`, `Synacthen: 30 minute cortisol result`, addisons_disease)
# write.csv(dat, 'outcome_dat.csv')
final_dataset<- final_dataset%>%
mutate(Ethnicity = as.factor(Ethnicity))
contrasts(final_dataset$Ethnicity) <-
contr.treatment(levels(final_dataset$Ethnicity),                                                    base = which(levels(final_dataset$Ethnicity) == 'Black African'))
ois_by_gender <- final_dataset %>%
mutate(
`Tuberculosis` = as.factor(`Opportunistic infection  (choice=Tuberculosis)`),
`Cryptococcus neoformans` = as.factor(`Opportunistic infection  (choice=Cryptococcus neoformans)`),
`Toxoplasmosis` = as.factor(`Opportunistic infection  (choice=Toxoplasmosis)`),
`Mycobacterium avium-intracellulare` = as.factor(`Opportunistic infection  (choice=Mycobacterium avium-intracellulare)`),
`Kaposis sarcoma` = as.factor(`Opportunistic infection  (choice=Kaposis sarcoma)`),
`Cytomegalovirus` = as.factor(`Opportunistic infection  (choice=Cytomegalovirus)`),
`Other` = as.factor(`Opportunistic infection  (choice=Other)`)
) %>%
dplyr::select(`Tuberculosis`, `Cryptococcus neoformans`, `Toxoplasmosis`, `Mycobacterium avium-intracellulare`, `Kaposis sarcoma`, `Cytomegalovirus`, `Other`, gender)
ois_by_gender <- final_dataset %>%
mutate(
`Tuberculosis` = as.factor(`Opportunistic infection  (choice=Tuberculosis)`),
`Cryptococcus neoformans` = as.factor(`Opportunistic infection  (choice=Cryptococcus neoformans)`),
`Toxoplasmosis` = as.factor(`Opportunistic infection  (choice=Toxoplasmosis)`),
`Mycobacterium avium-intracellulare` = as.factor(`Opportunistic infection  (choice=Mycobacterium avium-intracellulare)`),
`Kaposis sarcoma` = as.factor(`Opportunistic infection  (choice=Kaposis sarcoma)`),
`Cytomegalovirus` = as.factor(`Opportunistic infection  (choice=Cytomegalovirus)`),
`Other` = as.factor(`Opportunistic infection  (choice=Other)`)
)
View(final_dataset)
ois_by_gender <- final_dataset %>%
mutate(
`Tuberculosis` = as.factor(`Opportunistic infection  (choice=Tuberculosis)`),
`Cryptococcus neoformans` = as.factor(`Opportunistic infection  (choice=Cryptococcus neoformans)`),
`Toxoplasmosis` = as.factor(`Opportunistic infection  (choice=Toxoplasmosis)`),
`Mycobacterium avium-intracellulare` = as.factor(`Opportunistic infection  (choice=Mycobacterium avium-intracellulare)`),
`Kaposis sarcoma` = as.factor(`Opportunistic infection  (choice=Kaposis sarcoma)`),
`Cytomegalovirus` = as.factor(`Opportunistic infection  (choice=Cytomegalovirus)`),
`Other` = as.factor(`Opportunistic infection  (choice=Other)`)
) %>%
dplyr::select(`Tuberculosis`, `Cryptococcus neoformans`, `Toxoplasmosis`, `Mycobacterium avium-intracellulare`, `Kaposis sarcoma`, `Cytomegalovirus`, `Other`, Gender) #%>% #, `Other, specify...67`
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(results = 'asis')
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(magrittr)
library(knitr)
library(kableExtra)
library(tinytex)
library(gmodels)
library(readxl)
# library(MASS)
library(gtsummary)
library(caret)
library(leaps)
library(MASS)
library(predtools)
library(randomForest)
library(mice)
library(psfmi)
library(survival)
library(ranger)
library(ggplot2)
library(dplyr)
library(ggfortify)
library(survminer)
final_dataset <- read_csv("final_dataset.csv", show_col_types = F) %>%
mutate(addisons_disease = ifelse(`Random cortisol result` < 500 & (`Synacthen: 30 minute cortisol result`< 550 & `ACTH result`> 13.9), 1, 0)) #%>%
# dat <- final_dataset %>%
# dplyr::select(`Hospital folder number`,`Random cortisol result`, `ACTH sample drawn`, `ACTH result`, `Synacthen: 0 minute cortisol result`, `Synacthen: 30 minute cortisol result`, addisons_disease)
# write.csv(dat, 'outcome_dat.csv')
final_dataset<- final_dataset%>%
mutate(Ethnicity = as.factor(Ethnicity))
contrasts(final_dataset$Ethnicity) <-
contr.treatment(levels(final_dataset$Ethnicity),                                                    base = which(levels(final_dataset$Ethnicity) == 'Black African'))
names(final_dataset)
table
table(final_dataset$Other, specify...67)
table(final_dataset$`Other, specify...67`)
80/(80+960)
1/5
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(results = 'asis')
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(magrittr)
library(knitr)
library(kableExtra)
library(tinytex)
library(gmodels)
library(readxl)
# library(MASS)
library(gtsummary)
library(caret)
library(leaps)
library(MASS)
library(predtools)
library(randomForest)
library(mice)
library(psfmi)
library(survival)
library(ranger)
library(ggplot2)
library(dplyr)
library(ggfortify)
library(survminer)
final_dataset <- read_csv("final_dataset.csv", show_col_types = F) %>%
mutate(addisons_disease = ifelse(`Random cortisol result` < 500 & (`Synacthen: 30 minute cortisol result`< 550 & `ACTH result`> 13.9), 1, 0)) #%>%
# dat <- final_dataset %>%
# dplyr::select(`Hospital folder number`,`Random cortisol result`, `ACTH sample drawn`, `ACTH result`, `Synacthen: 0 minute cortisol result`, `Synacthen: 30 minute cortisol result`, addisons_disease)
# write.csv(dat, 'outcome_dat.csv')
final_dataset<- final_dataset%>%
mutate(Ethnicity = as.factor(Ethnicity))
contrasts(final_dataset$Ethnicity) <-
contr.treatment(levels(final_dataset$Ethnicity),                                                    base = which(levels(final_dataset$Ethnicity) == 'Black African'))
table_mortality <- final_dataset %>%
dplyr::select(`Hospital folder number`, `3 followup_patientstatus`, `6 followup_patientstatus`, `12 followup_patientstatus`) %>%
pivot_longer(cols = c(`3 followup_patientstatus`, `6 followup_patientstatus`, `12 followup_patientstatus`),
names_to = 'col_num',
values_to = 'followup_patientstatus') %>%
dplyr::select(`Hospital folder number`, `followup_patientstatus`) %>%
group_by(`Hospital folder number`) %>%
mutate(mortality = ifelse(followup_patientstatus == 'Deceased --> EXIT form', 1,ifelse(followup_patientstatus == 'Alive', 0, 0))) %>%
dplyr::select(`Hospital folder number`, mortality)
table_mortality[is.na(table_mortality)] <- 0
table_mortality1 <- table_mortality %>%
group_by(`Hospital folder number`) %>%
mutate(mortality = max(mortality)) %>%
distinct(`Hospital folder number`, .keep_all = T)
time_to_death <- final_dataset%>%
dplyr::select(`Hospital folder number`, `3 followup_patientstatus`,
`6 followup_patientstatus`, `12 followup_patientstatus`
) %>%
mutate(flag1 = ifelse(`3 followup_patientstatus` == "Deceased --> EXIT form", 3, NA),
flag2 = ifelse(`6 followup_patientstatus` == "Deceased --> EXIT form", 6, NA),
flag3 = ifelse(`12 followup_patientstatus` == "Deceased --> EXIT form", 12, NA)) %>%
dplyr::select(`Hospital folder number`, flag1:flag3) %>%
pivot_longer(cols = c(flag1:flag3),
names_to = 'col_num',
values_to = 'time to death') %>%
dplyr::select(`Hospital folder number`, `time to death`) %>%
group_by(`Hospital folder number`) %>%
mutate(ttdeath = min(`time to death`, na.rm = T)) %>%
ungroup() %>%
mutate(ttdeath = ifelse(is.infinite(ttdeath), 12, ttdeath)) %>%
distinct(`Hospital folder number`, .keep_all = T) %>%
dplyr::select(`Hospital folder number`, ttdeath)
table_mortality1 <- table_mortality1 %>%
left_join(time_to_death, by = 'Hospital folder number')
table_3 <- final_dataset %>%
left_join(table_mortality1, by = 'Hospital folder number') %>%
mutate(Ethnicity = as.character(Ethnicity)) %>%
mutate(`log10 viral load` = log(`HIV viral load`, 10),
HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
gender = factor(Gender, labels = c('Females', 'Males')),
`Addisons disease`  = as.factor(ifelse(addisons_disease ==1, 'yes', ifelse(addisons_disease ==0, 'no', ''))),
Ethnicity = ifelse(Ethnicity== 'Asian' | Ethnicity== 'Coloured' | Ethnicity== 'White', 'Other', Ethnicity),
`Total CD4 count` = `Total CD4 count...9`) %>%
dplyr::select(`Age at enrolment`, gender, Ethnicity, `Duration of current illness`, `log10 viral load`, `Total CD4 count`, Sodium, Potassium, Haemoglobin, `White cell count`, `Lymphocyte count`, Neutrophils, `Addisons disease`, mortality, ttdeath) %>%
mutate(Ethnicity = as.numeric(as.factor(Ethnicity)),
gender = as.numeric(as.factor(gender)),
Addisons_disease = as.numeric(as.factor(`Addisons disease`)),
Log10_viralload = `log10 viral load`,
Age_at_enrolment = `Age at enrolment`,
Total_CD4_count = `Total CD4 count`,
White_cell_count = `White cell count`,
Lymphocyte_count = `Lymphocyte count`,
Duration_of_current_illness = `Duration of current illness`) %>%
dplyr::select(Age_at_enrolment, gender, Ethnicity, Duration_of_current_illness, Log10_viralload, Total_CD4_count, Sodium, Potassium, Haemoglobin, White_cell_count, Lymphocyte_count, Neutrophils, Addisons_disease, mortality, ttdeath)
tbl_uvregression(
table_3,
method=coxph,
y = Surv(time = ttdeath, event = mortality),
exponentiate = TRUE#,
# include = -ID
)
nr_imputations <- 5
imputedData <- mice::mice(data = data.frame(table_3), m = nr_imputations, maxit = 20, meth = 'pmm', seed = 33)
x=pool(imputedData)
View(table_3)
my.variable.list <- names(model_dataset[, 1:12]) #model_dataset[,1:16,20:22])
x=with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Neutrophils + Lymphocyte_count + Potassium, data = model_dataset))
x=with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Neutrophils + Lymphocyte_count + Potassium))
x1 = pool(x)
summary(pool(x))
model1 <- pool(with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Neutrophils + Lymphocyte_count + Potassium)))
model1 <- summary(pool(with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Neutrophils + Lymphocyte_count + Potassium))))
# summary(model1)
coef(model1)
model1
class(model1)
model1[2]
exp(model1[2])
x <- My.stepwise::My.stepwise.coxph(Time = "ttdeath", Status = "mortality", variable.list = my.variable.list,
in.variable = c("Addisons_disease"), data = model_dataset, sle = 0.20, sls = 0.20)
model_dataset <- completeData
nr_imputations <- 5
imputedData <- mice::mice(data = data.frame(table_3), m = nr_imputations, maxit = 20, meth = 'pmm', seed = 33)
completeData <- complete(imputedData, 2)
my.variable.list <- names(model_dataset[, 1:12]) #model_dataset[,1:16,20:22])
x <- My.stepwise::My.stepwise.coxph(Time = "ttdeath", Status = "mortality", variable.list = my.variable.list,
in.variable = c("Addisons_disease"), data = model_dataset, sle = 0.20, sls = 0.20)
my.variable.list <- names(completeData[, 1:12]) #model_dataset[,1:16,20:22])
x <- My.stepwise::My.stepwise.coxph(Time = "ttdeath", Status = "mortality", variable.list = my.variable.list,
in.variable = c("Addisons_disease"), data = model_dataset, sle = 0.20, sls = 0.20)
model_dataset
x <- My.stepwise::My.stepwise.coxph(Time = "ttdeath", Status = "mortality", variable.list = my.variable.list,
in.variable = c("Addisons_disease"), data = completeData, sle = 0.20, sls = 0.20)
names(x)
x
x <- My.stepwise::My.stepwise.coxph(Time = "ttdeath", Status = "mortality", variable.list = my.variable.list,
in.variable = c("Addisons_disease"), data = completeData, sle = 0.20, sls = 0.20)
print(x)
names(completeData[, 1:12]))
str(completeData[, 1:12]))
str(completeData)
scope <- list(upper = ~ Age_at_enrolment + gender + Ethnicity+ Duration_of_current_illness + Log10_viralload + Total_CD4_count+ Sodium + Potassium + Haemoglobin + White_cell_count + Lymphocyte_count+ Neutrophils + Addisons_disease,
lower = ~1)
expr <- expression(f1 <- coxph(Surv(ttdeath, mortality) ~ 1),
f2 <- step(f1, scope = scope))
fit <- with(data=imputedData, expr)
formulas <- lapply(fit$analyses, formula)
terms <- lapply(formulas, terms)
votes <- unlist(lapply(terms, labels))
table(votes)
?step
table(table_3$mortality)
model1 <- summary(pool(with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Lymphocyte_count + Potassium + Ethnicity))))
model1
# model1 <- survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Neutrophils + Lymphocyte_count + Potassium, data = model_dataset) # + gender
f1 <- with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Lymphocyte_count + Potassium + Ethnicity))
f2 <- with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Lymphocyte_count + Potassium + Ethnicity + gender))
D1(fi, f2)
D1(f1, f2)
D1(f1, f2)
model1 <- summary(pool(with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Lymphocyte_count + Potassium + Ethnicity))))
model2 <- summary(pool(with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Lymphocyte_count + Potassium + gender))))
model1
model2
(-0.15405975--0.12922009)/-0.15405975
model2[1]
l_ci = model2[2] - 1.96 * model2[3]
l_ci
u_ci = model2[2] + 1.96 * model2[3]
cbind(model2[1], l_ci, u_ci, modle2[6])
cbind(model2[1], l_ci, u_ci, model2[6])
# summary(model1)
# coef(model1)
# confint(model1)
final_model_table <- cbind(exp(model2[1]), exp(model2[2] - 1.96 * model2[3]), exp(model2[2] + 1.96 * model2[3]), model2[6])
exp(model2[[2:5])
exp(model2[[2:5]]
)
model2[[2:5]]
model2[1]
exp(model2[2])
# summary(model1)
# coef(model1)
# confint(model1)
final_model_table <- cbind(model2[1], exp(model2[2]), exp(model2[2] - 1.96 * model2[3]), exp(model2[2] + 1.96 * model2[3]), model2[6])
final_model_table
View(final_model_table)
# summary(model1)
# coef(model1)
# confint(model1)
final_model_table <- cbind(variable = model2[1], adj_HR = exp(model2[2]), l_ci = exp(model2[2] - 1.96 * model2[3]), u_ci = exp(model2[2] + 1.96 * model2[3]), model2[6])
View(final_model_table)
names(final_model_table)
names(final_model_table) <- c('variable', 'Adj_HR', 'Lower_CI', 'upper_CI', 'P value')
View(final_model_table)
# mv_table <- #data.frame(
#   cbind(exp(cbind(coef(model1),confint(model1))), p_value = round(summary(model1)$coefficients[,5], 4))
#   #)
# final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)), summary(model1)$coefficients[, 5])) %>%
#   mutate(Variable = c("Addison's disease", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium'), Adj.HR = round(V1,3), `95%CI` = paste('(', round(`X2.5..`, 5), ', ', round(`X97.5..`, 5), ')', sep = ''), `P value` = V4) %>% #, 'gender'
#   dplyr::select(Variable, Adj.HR, `95%CI`, `P value`)
# row.names(final_table) <- 1:length(final_table$Variable)
write.csv(final_model_table, 'final_table_updated.csv')
unlink("analysis_file_tables_cache", recursive = TRUE)
scope <- list(upper = ~ Age_at_enrolment + gender + Ethnicity+ Duration_of_current_illness + Log10_viralload + Total_CD4_count+ Sodium + Potassium + Haemoglobin + White_cell_count + Lymphocyte_count+ Neutrophils + Addisons_disease,
lower = ~1)
expr <- expression(f1 <- coxph(Surv(ttdeath, mortality) ~ 1),
f2 <- step(f1, scope = scope))
fit <- with(data=imputedData, expr)
formulas <- lapply(fit$analyses, formula)
terms <- lapply(formulas, terms)
votes <- unlist(lapply(terms, labels))
table(votes)
# model1 <- survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Neutrophils + Lymphocyte_count + Potassium, data = model_dataset) # + gender
f1 <- with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Lymphocyte_count + Potassium + Ethnicity))
f2 <- with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Lymphocyte_count + Potassium + Ethnicity + gender))
D1(f1, f2)
getwd()
# mv_table <- #data.frame(
#   cbind(exp(cbind(coef(model1),confint(model1))), p_value = round(summary(model1)$coefficients[,5], 4))
#   #)
# final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)), summary(model1)$coefficients[, 5])) %>%
#   mutate(Variable = c("Addison's disease", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium'), Adj.HR = round(V1,3), `95%CI` = paste('(', round(`X2.5..`, 5), ', ', round(`X97.5..`, 5), ')', sep = ''), `P value` = V4) %>% #, 'gender'
#   dplyr::select(Variable, Adj.HR, `95%CI`, `P value`)
# row.names(final_table) <- 1:length(final_table$Variable)
write.csv(final_model_table, 'final_table_updated.csv')
# mv_table <- #data.frame(
#   cbind(exp(cbind(coef(model1),confint(model1))), p_value = round(summary(model1)$coefficients[,5], 4))
#   #)
# final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)), summary(model1)$coefficients[, 5])) %>%
#   mutate(Variable = c("Addison's disease", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium'), Adj.HR = round(V1,3), `95%CI` = paste('(', round(`X2.5..`, 5), ', ', round(`X97.5..`, 5), ')', sep = ''), `P value` = V4) %>% #, 'gender'
#   dplyr::select(Variable, Adj.HR, `95%CI`, `P value`)
# row.names(final_table) <- 1:length(final_table$Variable)
write.csv(final_model_table, 'final_table_updated1.csv')
unlink("analysis_file_tables_cache", recursive = TRUE)
# summary(model1)
# coef(model1)
# confint(model1)
final_model_table <- cbind(variable = model2[1], adj_HR = round(exp(model2[2]), 3), l_ci = round(exp(model2[2] - 1.96 * model2[3]), 4), u_ci = round(exp(model2[2] + 1.96 * model2[3]), 4), round(model2[6], 5))
names(final_model_table) <- c('variable', 'Adj_HR', 'Lower_CI', 'upper_CI', 'P value')
# mv_table <- #data.frame(
#   cbind(exp(cbind(coef(model1),confint(model1))), p_value = round(summary(model1)$coefficients[,5], 4))
#   #)
# final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)), summary(model1)$coefficients[, 5])) %>%
#   mutate(Variable = c("Addison's disease", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium'), Adj.HR = round(V1,3), `95%CI` = paste('(', round(`X2.5..`, 5), ', ', round(`X97.5..`, 5), ')', sep = ''), `P value` = V4) %>% #, 'gender'
#   dplyr::select(Variable, Adj.HR, `95%CI`, `P value`)
# row.names(final_table) <- 1:length(final_table$Variable)
write.csv(final_model_table, 'final_table_updated_ver 2.csv')
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(results = 'asis')
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(magrittr)
library(knitr)
library(kableExtra)
library(tinytex)
library(gmodels)
library(readxl)
# library(MASS)
library(gtsummary)
library(caret)
library(leaps)
library(MASS)
library(predtools)
library(randomForest)
library(mice)
library(psfmi)
library(survival)
library(ranger)
library(ggplot2)
library(dplyr)
library(ggfortify)
library(survminer)
final_dataset <- read_csv("final_dataset.csv", show_col_types = F) %>%
mutate(addisons_disease = ifelse(`Random cortisol result` < 500 & (`Synacthen: 30 minute cortisol result`< 550 & `ACTH result`> 13.9), 1, 0)) #%>%
# dat <- final_dataset %>%
# dplyr::select(`Hospital folder number`,`Random cortisol result`, `ACTH sample drawn`, `ACTH result`, `Synacthen: 0 minute cortisol result`, `Synacthen: 30 minute cortisol result`, addisons_disease)
# write.csv(dat, 'outcome_dat.csv')
final_dataset<- final_dataset%>%
mutate(Ethnicity = as.factor(Ethnicity))
contrasts(final_dataset$Ethnicity) <-
contr.treatment(levels(final_dataset$Ethnicity),                                                    base = which(levels(final_dataset$Ethnicity) == 'Black African'))
names(final_dataset)
table_2 <- final_dataset %>%
mutate(Ethnicity = as.character(Ethnicity)) %>%
mutate(`log10 viral load` = log(`HIV viral load`, 10),
HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
gender = factor(Gender, labels = c('Females', 'Males')),
`Addisons disease`  = as.factor(ifelse(addisons_disease ==1, 'yes', ifelse(addisons_disease ==0, 'no', ''))),
Ethnicity = ifelse(Ethnicity== 'Asian' | Ethnicity== 'Coloured' | Ethnicity== 'White', 'Other', Ethnicity)) %>%
dplyr::select(`Age at enrolment`, gender, Ethnicity, `Duration of current illness`, `Opportunistic infection present`, `log10 viral load`, `Total CD4 count...9`, Sodium, Potassium, Haemoglobin, `White cell count`, `Lymphocyte count`, Neutrophils, `Addisons disease`) %>%
mutate(`Addisons disease` = forcats::fct_rev(`Addisons disease`)) %>%
tbl_summary(#table_1,
missing = "no",
by = `Addisons disease`,
# statistic = list(all_continuous() ~ "{mean} ({sd})"),
digits = list(all_categorical() ~ c(0, 1)),
label = list(`Total CD4 count...9` ~ 'Total CD4 count')
) %>%
add_p() %>%
add_n() %>%
modify_header(label = "Variable") %>% # update the column header
bold_labels()
table_2
table_2 <- final_dataset %>%
mutate(Ethnicity = as.character(Ethnicity)) %>%
mutate(`log10 viral load` = log(`HIV viral load`, 10),
HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
gender = factor(Gender, labels = c('Females', 'Males')),
`Addisons disease`  = as.factor(ifelse(addisons_disease ==1, 'yes', ifelse(addisons_disease ==0, 'no', ''))),
Ethnicity = ifelse(Ethnicity== 'Asian' | Ethnicity== 'Coloured' | Ethnicity== 'White', 'Other', Ethnicity)) %>%
dplyr::select(`Age at enrolment`, gender, Ethnicity, `Duration of current illness`, `Presence of  an opportunistic infection present` = `Opportunistic infection present`, `log10 viral load`, `Total CD4 count...9`, Sodium, Potassium, Haemoglobin, `White cell count`, `Lymphocyte count`, Neutrophils, `Addisons disease`) %>%
mutate(`Addisons disease` = forcats::fct_rev(`Addisons disease`)) %>%
tbl_summary(#table_1,
missing = "no",
by = `Addisons disease`,
# statistic = list(all_continuous() ~ "{mean} ({sd})"),
digits = list(all_categorical() ~ c(0, 1)),
label = list(`Total CD4 count...9` ~ 'Total CD4 count')
) %>%
add_p() %>%
add_n() %>%
modify_header(label = "Variable") %>% # update the column header
bold_labels()
table_2
table_2 <- final_dataset %>%
mutate(Ethnicity = as.character(Ethnicity)) %>%
mutate(`log10 viral load` = log(`HIV viral load`, 10),
HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
gender = factor(Gender, labels = c('Females', 'Males')),
`Addisons disease`  = as.factor(ifelse(addisons_disease ==1, 'yes', ifelse(addisons_disease ==0, 'no', ''))),
Ethnicity = ifelse(Ethnicity== 'Asian' | Ethnicity== 'Coloured' | Ethnicity== 'White', 'Other', Ethnicity)) %>%
dplyr::select(`Age at enrolment, median (IQR) (years)` = `Age at enrolment`, `Gender, n(%)` = gender, Ethnicity, `Duration of current illness (days)` = `Duration of current illness`, `Presence of  an opportunistic infection` = `Opportunistic infection present`, `Viral load (log10 Copies/mL)` = `log10 viral load`, `Total CD4 count...9`, `Sodium mmol/L` = Sodium, `Potassium mmol/L` = Potassium, `Haemoglobin g/dL` = Haemoglobin, `White cell count X109` = `White cell count`, `Lymphocyte count X109` = `Lymphocyte count`, Neutrophils, `Addisons disease`) %>%
mutate(`Addisons disease` = forcats::fct_rev(`Addisons disease`)) %>%
tbl_summary(#table_1,
missing = "no",
by = `Addisons disease`,
# statistic = list(all_continuous() ~ "{mean} ({sd})"),
digits = list(all_categorical() ~ c(0, 1)),
label = list(`Total CD4 count...9` ~ 'Total CD4 count')
) %>%
add_p() %>%
add_n() %>%
modify_header(label = "Variable") %>% # update the column header
bold_labels()
table_2
