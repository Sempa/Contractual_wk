---
title: "Adddison's disease associated with advanced HIV may explain the high mortality"
author: "Dr Joseph B Sempa"
date: "`r Sys.Date()`"
output:
  word_document:
    fig_caption: yes
    toc: yes
  pdf_document:
    fig_caption: yes
    toc: yes
  html_document:
    fig_caption: yes
    toc: yes
  html_notebook:
    toc: yes
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(results = 'asis')
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(magrittr)
library(knitr)
library(kableExtra)
library(tinytex)
library(gmodels)
library(readxl)
# library(MASS)
library(gtsummary)
library(caret)
library(leaps)
library(MASS)
library(predtools)
library(randomForest)
library(mice)
library(psfmi)
```


```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
final_dataset <- read_csv("final_dataset.csv", show_col_types = F) %>%
  mutate(addisons_disease = ifelse(`Random cortisol result` < 500 & (`Synacthen: 30 minute cortisol result`< 550 & `ACTH result`> 13.9), 1, 0)) #%>%
# dat <- final_dataset %>%
# dplyr::select(`Hospital folder number`,`Random cortisol result`, `ACTH sample drawn`, `ACTH result`, `Synacthen: 0 minute cortisol result`, `Synacthen: 30 minute cortisol result`, addisons_disease)
# write.csv(dat, 'outcome_dat.csv')
```


```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
socio_demographics <- final_dataset %>%
  dplyr::select(`Age at enrolment`, Gender, Ethnicity)
tbl_summary(socio_demographics, missing = "no",
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

dt01 <- final_dataset %>%
  dplyr::select(`Hospital folder number`, `Primary medical conditions (1)`,
`Primary medical conditions (2)`,
`Primary medical conditions (3)`,
`Primary medical conditions (4)`,
`Primary medical conditions (5)`,
`Primary medical conditions (6)`,
`Primary medical conditions (7)`,
`Primary medical conditions (8)`,
`Primary medical conditions (9)`,
`Primary medical conditions (10)`) %>%
  pivot_longer(cols = c(`Primary medical conditions (1)`,
`Primary medical conditions (2)`,
`Primary medical conditions (3)`,
`Primary medical conditions (4)`,
`Primary medical conditions (5)`,
`Primary medical conditions (6)`,
`Primary medical conditions (7)`,
`Primary medical conditions (8)`,
`Primary medical conditions (9)`,
`Primary medical conditions (10)`),
               names_to = 'col_num',
               values_to = 'Primary medical conditions') %>%
  dplyr::select(`Hospital folder number`, `Primary medical conditions`) %>%
  filter(!is.na(`Primary medical conditions`))

dt02 <- final_dataset %>%
  dplyr::select(`Hospital folder number`, `Co-existing medical conditions (1)`,
`Co-existing medical conditions (2)`,
`Co-existing medical conditions (3)`,
`Co-existing medical conditions (4)`,
`Co-existing medical conditions (5)`,
`Co-existing medical conditions (6)`,
`Co-existing medical conditions (7)`,
`Co-existing medical conditions (8)`,
`Co-existing medical conditions (9)`,
`Co-existing medical conditions (10)`) %>%
  pivot_longer(cols = c(`Co-existing medical conditions (1)`,
`Co-existing medical conditions (2)`,
`Co-existing medical conditions (3)`,
`Co-existing medical conditions (4)`,
`Co-existing medical conditions (5)`,
`Co-existing medical conditions (6)`,
`Co-existing medical conditions (7)`,
`Co-existing medical conditions (8)`,
`Co-existing medical conditions (9)`,
`Co-existing medical conditions (10)`),
               names_to = 'col_num',
               values_to = 'Co-existing medical conditions') %>%
  dplyr::select(`Hospital folder number`, `Co-existing medical conditions`) %>%
  filter(!is.na(`Co-existing medical conditions`))

clinical <- final_dataset %>%
  mutate(`days since employment` = as.Date(`Date of enrolment in study`)- as.Date(`Last Employment date`)) %>%
  dplyr::select(`HIV-positive, confirmed on ELISA`, `Total CD4 count...9`, `CD4 < 100`, `Opportunistic infection present`, `Oral or inhaled steroids in the last three months`, `days since employment`, `Duration of current illness`)
tbl_summary(clinical, missing = "no",
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()
opportunistic_infections <- final_dataset %>%
  dplyr::select(`Opportunistic infection  (choice=Tuberculosis)`, `Opportunistic infection  (choice=Cryptococcus neoformans)`, `Opportunistic infection  (choice=Toxoplasmosis)`, `Opportunistic infection  (choice=Mycobacterium avium-intracellulare)`, `Opportunistic infection  (choice=Kaposis sarcoma)`, `Opportunistic infection  (choice=Cytomegalovirus)`, `Opportunistic infection  (choice=Other)`) #, `Other, specify...67`
tbl_summary(opportunistic_infections, missing = "no",
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

signs_table1 <- final_dataset %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10)) %>%
  dplyr::select(`BP (systolic)`, `BP (diastolic)`, `Heart rate`, Hypotension, Weakness, Tiredness, `Poor appetite`, `Weight loss`, `Increased pigmentation of the skin`, Nausea)
tbl_summary(signs_table1, missing = "no",
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

signs_table2 <- final_dataset %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10)) %>%
  dplyr::select(Vomiting, `Liking for salt`, Hypoglycaemia, `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, `Loss of axillary and pubic hair, if female`, `Any postural drop in blood pressure`)
tbl_summary(signs_table2, missing = "no",
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

signs_table3 <- final_dataset %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10)) %>%
  dplyr::select(`Presence of anaemia`, `Total CD4 count...89`, `log10 viral load`, `Or, HIV viral load = LDL (choice=LDL)`, `Current tuberculosis`, `Past tuberculosis`, `Electrolytes available`, Sodium, Potassium, Urea)
tbl_summary(signs_table3, missing = "no",
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

signs_table4 <- final_dataset %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10)) %>%
  dplyr::select(Creatinine, `Full blood count (FBC) result available`, Haemoglobin, `White cell count`, Platelets, MCV, `Differential on FBC available`, Neutrophils, `Lymphocyte count`, Eosinophils, Basophils, `Aetiology of anaemia`) #, `Other, specify...112`
tbl_summary(signs_table4, missing = "no",
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

outcome_variables <- final_dataset %>%
  mutate(`Random cortisol result coded` = cut(`Random cortisol result`, breaks = c(80,500,1400)),
         `ACTH result coded` = cut(`ACTH result`, breaks = c(0, 13.9, 500))
         ) %>%
  dplyr::select(`Random cortisol result`, `Random cortisol result coded`, `ACTH result`, `ACTH result coded`, `Antibodies sample drawn`, `Confirm random cortisol < 500 nmol/L`, `Confirm patient not on steroids for past 3 months`, `Synacthen: 0 minute cortisol result`, `Synacthen: 30 minute cortisol result`, addisons_disease)
tbl_summary(outcome_variables, missing = "no",
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

ctscan <- final_dataset %>%
  dplyr::select(`CT scan done`, `Bilateral adrenal enlargement`, `Calcification`, Atrophy, Haemorrhage, Nodularity, `Outcome of hospitalization`)
tbl_summary(ctscan, missing = "no",
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

follow_up <- final_dataset %>%
  dplyr::select( `3 followup_done`, `3 followup_patientstatus`, `3 followup_patientcondition`, `6 followup_done`, `6 followup_patientstatus`, `6 followup_patientcondition`, `12 followup_done`, `12 followup_patientstatus`, `12 followup_patientcondition`, `If deceased, cause of death`)
tbl_summary(follow_up, missing = "no",
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()
```

# Table 2: Patients diagnosed with hypoadrenalism in advanced HIV study, compred to those with normal adreal function

## Socio-demographics by hypoadrenalism + advanced HIV and without
patients with hypoadrenalism with advanced HIV (CD4<100) and not on steriods whether oral or injectable
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

socio_demographics2 <- final_dataset %>%
  mutate(addisons_disease_advanced_HIV = ifelse(addisons_disease==1 & `CD4 < 100`==1 & `Oral or inhaled steroids in the last three months`=='No', 1, 0)) %>%
  mutate(gender = as.factor(Gender),
         ethnicity = as.factor(Ethnicity)) %>%
  dplyr::select(addisons_disease_advanced_HIV, `Age at enrolment`, gender, ethnicity)
  
  tbl_uvregression(
    socio_demographics2[c('addisons_disease_advanced_HIV', 'Age at enrolment', 'gender', 'ethnicity')],
    method = glm,
    y = addisons_disease_advanced_HIV,
    method.args = list(family = binomial),
    exponentiate = TRUE
  )


```

# Table 2: Signs by hypoadrenalism + advanced HIV and without

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

signs_table12 <- final_dataset %>%
  mutate(addisons_disease_advanced_HIV = ifelse(addisons_disease==1 & `CD4 < 100`==1 & `Oral or inhaled steroids in the last three months`=='No', 1, 0)) %>%
  mutate(#`log10 viral load` = log(`HIV viral load`, 10),
         Hypotension = as.factor(Hypotension),
         Weakness = as.factor(Weakness),
         Tiredness = as.factor(Tiredness),
         `Poor appetite` = as.factor(`Poor appetite`),
         `Weight loss` = as.factor(`Weight loss`),
         `Increased pigmentation of the skin` = as.factor(`Increased pigmentation of the skin`),
         Nausea = as.factor(Nausea)
         ) %>%
  dplyr::select(`BP (systolic)`, `BP (diastolic)`, `Heart rate`, Hypotension, Weakness, Tiredness, `Poor appetite`, `Weight loss`, `Increased pigmentation of the skin`, Nausea, addisons_disease_advanced_HIV) 
tbl_uvregression(
    signs_table12[c('BP (systolic)', 'BP (diastolic)', 'Heart rate', 'Hypotension', 'Weakness', 'Tiredness', 'Poor appetite', 'Weight loss', 'Increased pigmentation of the skin', 'Nausea', 'addisons_disease_advanced_HIV')],
    method = glm,
    y = addisons_disease_advanced_HIV,
    method.args = list(family = binomial),
    exponentiate = TRUE
  )

```


# Table 2: Signs by hypoadrenalism + advanced HIV and without - Continued 2

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

signs_table22 <- final_dataset %>%
  mutate(addisons_disease_advanced_HIV = ifelse(addisons_disease==1 & `CD4 < 100`==1 & `Oral or inhaled steroids in the last three months`=='No', 1, 0)) %>%
  mutate(
         Vomiting = as.factor(Vomiting),
         `Liking for salt` = as.factor(`Liking for salt`),
         Hypoglycaemia = as.factor(Hypoglycaemia),
         `Loss of consciousness` = as.factor(`Loss of consciousness`),
         Diarrhoea = as.factor(Diarrhoea),
         Dizziness = as.factor(Dizziness),
         Shock = as.factor(Shock),
         Anorexia = as.factor(Anorexia),
         `Loss of axillary and pubic hair, if female` = as.factor(`Loss of axillary and pubic hair, if female`),
         `Any postural drop in blood pressure` = as.factor(`Any postural drop in blood pressure`)
         ) %>%
  dplyr::select(Vomiting, `Liking for salt`, Hypoglycaemia, `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, `Loss of axillary and pubic hair, if female`, `Any postural drop in blood pressure`, addisons_disease_advanced_HIV)

tbl_uvregression(
    signs_table22[c('Vomiting', 'Liking for salt', 'Hypoglycaemia', 'Loss of consciousness', 'Diarrhoea', 'Dizziness', 'Shock', 'Anorexia', 'Loss of axillary and pubic hair, if female', 'Any postural drop in blood pressure', 'addisons_disease_advanced_HIV')],
    method = glm,
    y = addisons_disease_advanced_HIV,
    method.args = list(family = binomial),
    exponentiate = TRUE
  )

```


# Table 2: Signs by hypoadrenalism + advanced HIV and without - Continued 3

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

signs_table32 <- final_dataset %>%
  mutate(addisons_disease_advanced_HIV = ifelse(addisons_disease==1 & `CD4 < 100`==1 & `Oral or inhaled steroids in the last three months`=='No', 1, 0)) %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10),
         `Presence of anaemia` = as.factor(`Presence of anaemia`),
         `Or, HIV viral load = LDL (choice=LDL)` = as.factor(`Or, HIV viral load = LDL (choice=LDL)`),
         `Current tuberculosis` = as.factor(`Current tuberculosis`),
         `Past tuberculosis` = as.factor(`Past tuberculosis`),
         `Electrolytes available` = as.factor(`Electrolytes available`),
         `Total CD4 count` = `Total CD4 count...89`) %>%
  dplyr::select(`Presence of anaemia`, `Total CD4 count`, `log10 viral load`, `Or, HIV viral load = LDL (choice=LDL)`, `Current tuberculosis`, `Past tuberculosis`, `Electrolytes available`, Sodium, Potassium, Urea, addisons_disease_advanced_HIV) 
tbl_uvregression(
    signs_table32[c('Presence of anaemia', 'Total CD4 count', 'log10 viral load', 'Or, HIV viral load = LDL (choice=LDL)', 'Current tuberculosis', 'Past tuberculosis', 'Sodium', 'Potassium', 'Urea', 'addisons_disease_advanced_HIV')],
    method = glm,
    y = addisons_disease_advanced_HIV,
    method.args = list(family = binomial),
    exponentiate = TRUE
  ) 
```


```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

signs_table42 <- final_dataset %>%
  mutate(addisons_disease_advanced_HIV = ifelse(addisons_disease==1 & `CD4 < 100`==1 & `Oral or inhaled steroids in the last three months`=='No', 1, 0)) %>%
  mutate(
    `Full blood count (FBC) result available` = as.factor(`Full blood count (FBC) result available`),
    `Differential on FBC available` = as.factor(`Differential on FBC available`),
    `Aetiology of anaemia` = as.factor(`Aetiology of anaemia`)
    ) %>%
  dplyr::select(Creatinine, `Full blood count (FBC) result available`, Haemoglobin, `White cell count`, Platelets, MCV, `Differential on FBC available`, Neutrophils, `Lymphocyte count`, Eosinophils, Basophils, `Aetiology of anaemia`, addisons_disease_advanced_HIV) 
tbl_uvregression(
    signs_table42[c('Creatinine', 'Full blood count (FBC) result available', 'Haemoglobin', 'White cell count', 'Platelets', 'MCV', 'Differential on FBC available', 'Neutrophils', 'Lymphocyte count', 'Eosinophils', 'Basophils', 'Aetiology of anaemia', 'addisons_disease_advanced_HIV')],
    method = glm,
    y = addisons_disease_advanced_HIV,
    method.args = list(family = binomial),
    exponentiate = TRUE
  ) 
```

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

ctscan2 <- final_dataset %>%
  mutate(addisons_disease_advanced_HIV = ifelse(addisons_disease==1 & `CD4 < 100`==1 & `Oral or inhaled steroids in the last three months`=='No', 1, 0)) %>%
  mutate(`CT scan done` = as.factor(`CT scan done`),
         Nodularity = as.factor(Nodularity),
         `Bilateral adrenal enlargement` = as.factor(`Bilateral adrenal enlargement`),
         `Calcification` = as.factor(`Calcification`),
         Atrophy = as.factor(Atrophy),
         Haemorrhage = as.factor(Haemorrhage),
         `Outcome of hospitalization` = as.factor(`Outcome of hospitalization`)) %>%
  dplyr::select(`CT scan done`, `Bilateral adrenal enlargement`, `Calcification`, Atrophy, Haemorrhage, Nodularity, `Outcome of hospitalization`, addisons_disease_advanced_HIV) 
# tbl_uvregression(
#     ctscan2[c(#'CT scan done', 
#               # 'Bilateral adrenal enlargement', 
#               # 'Calcification', 
#               # 'Atrophy', 
#               # 'Haemorrhage', 'Nodularity', 
#               'Outcome of hospitalization', 'addisons_disease_advanced_HIV')],
#     method = glm,
#     y = addisons_disease_advanced_HIV,
#     method.args = list(family = binomial),
#     exponentiate = TRUE
#   ) 
```

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

follow_up2 <- final_dataset %>%
  mutate(addisons_disease_advanced_HIV = ifelse(addisons_disease==1 & `CD4 < 100`==1 & `Oral or inhaled steroids in the last three months`=='No', 1, 0)) %>%
  mutate(`3 followup_done` = as.factor(`3 followup_done`),
         `3 followup_patientstatus` = as.factor(`3 followup_patientstatus`),
         `3 followup_patientcondition` = as.factor(`3 followup_patientcondition`),
         `6 followup_done` = as.factor(`6 followup_done`),
         `6 followup_patientstatus` = as.factor(`6 followup_patientstatus`),
         `6 followup_patientcondition` = as.factor(`6 followup_patientcondition`),
         `12 followup_done` = as.factor(`12 followup_done`),
         `12 followup_patientstatus` = as.factor(`12 followup_patientstatus`),
         `12 followup_patientcondition` = as.factor(`12 followup_patientcondition`),
         `If deceased, cause of death` = as.factor(`If deceased, cause of death`)
         ) %>%
  dplyr::select(`3 followup_done`, `3 followup_patientstatus`, `3 followup_patientcondition`, `6 followup_done`, `6 followup_patientstatus`, `6 followup_patientcondition`, `12 followup_done`, `12 followup_patientstatus`, `12 followup_patientcondition`, `If deceased, cause of death`, addisons_disease_advanced_HIV)
tbl_uvregression(
    follow_up2[c('3 followup_done', '3 followup_patientstatus', '3 followup_patientcondition', '6 followup_done', '6 followup_patientstatus', '6 followup_patientcondition', '12 followup_done', '12 followup_patientstatus', '12 followup_patientcondition', 'If deceased, cause of death', 'addisons_disease_advanced_HIV')],
    method = glm,
    y = addisons_disease_advanced_HIV,
    method.args = list(family = binomial),
    exponentiate = TRUE
  ) 
```

# Table 3: Clinical features predictive of hypoadrenalism--addisons_disease (hypoadrenalism status of study paticipants) vs other variables
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
socio_demographics <- final_dataset %>%
  mutate(gender = as.factor(Gender),
         ethnicity = as.factor(Ethnicity)) %>%
  dplyr::select(`Age at enrolment`, gender, ethnicity, addisons_disease) %>%
tbl_summary(by = addisons_disease, 
            missing = "no",
            statistic = list(all_continuous() ~ "{mean} ({sd})")
            ) %>% 
  add_p() %>%
  add_n() %>% 
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()
socio_demographics
```


```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

clinical <- final_dataset %>%
  mutate(`days since employment` = as.Date(`Date of enrolment in study`)- as.Date(`Last Employment date`)) %>%
  mutate(`HIV-positive, confirmed on ELISA` = as.factor(`HIV-positive, confirmed on ELISA`),
         `Opportunistic infection present` = as.factor(`Opportunistic infection present`),
         `Oral or inhaled steroids in the last three months` = as.factor(`Oral or inhaled steroids in the last three months`)
         ) %>%
  dplyr::select(`HIV-positive, confirmed on ELISA`, `Total CD4 count...9`, `CD4 < 100`, `Opportunistic infection present`, `Oral or inhaled steroids in the last three months`, `days since employment`, `Duration of current illness`, addisons_disease) %>%
tbl_summary(#clinical, 
            missing = "no",
            by = addisons_disease,
            label = list(`Total CD4 count...9` ~ 'Total CD4 count'),
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  add_p() %>%
  add_n() %>%  
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

clinical
```

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

opportunistic_infections <- final_dataset %>%
  mutate(
    `Tuberculosis` = as.factor(`Opportunistic infection  (choice=Tuberculosis)`),
    `Cryptococcus neoformans` = as.factor(`Opportunistic infection  (choice=Cryptococcus neoformans)`),
    `Toxoplasmosis` = as.factor(`Opportunistic infection  (choice=Toxoplasmosis)`),
    `Mycobacterium avium-intracellulare` = as.factor(`Opportunistic infection  (choice=Mycobacterium avium-intracellulare)`),
    `Kaposis sarcoma` = as.factor(`Opportunistic infection  (choice=Kaposis sarcoma)`),
    `Cytomegalovirus` = as.factor(`Opportunistic infection  (choice=Cytomegalovirus)`),
    `Other` = as.factor(`Opportunistic infection  (choice=Other)`)
  ) %>%
  dplyr::select(`Tuberculosis`, `Cryptococcus neoformans`, `Toxoplasmosis`, `Mycobacterium avium-intracellulare`, `Kaposis sarcoma`, `Cytomegalovirus`, `Other`, addisons_disease) #%>% #, `Other, specify...67`
tbl_summary(opportunistic_infections,
            missing = "no",
            by = addisons_disease
            ) %>%
add_p() %>%
add_n() 

opportunistic_infections
```

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

signs_table1 <- final_dataset %>%
  mutate(#`log10 viral load` = log(`HIV viral load`, 10),
         Hypotension = as.factor(Hypotension),
         Weakness = as.factor(Weakness),
         Tiredness = as.factor(Tiredness),
         `Poor appetite` = as.factor(`Poor appetite`),
         `Weight loss` = as.factor(`Weight loss`),
         `Increased pigmentation of the skin` = as.factor(`Increased pigmentation of the skin`),
         Nausea = as.factor(Nausea)
         ) %>%
  dplyr::select(`BP (systolic)`, `BP (diastolic)`, `Heart rate`, Hypotension, Weakness, Tiredness, `Poor appetite`, `Weight loss`, `Increased pigmentation of the skin`, Nausea, addisons_disease) %>%
tbl_summary(#signs_table1, 
            missing = "no",
            by = addisons_disease,
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  add_p() %>%
  add_n() %>%  
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

signs_table1
```

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

signs_table2 <- final_dataset %>%
  mutate(
         Vomiting = as.factor(Vomiting),
         `Liking for salt` = as.factor(`Liking for salt`),
         Hypoglycaemia = as.factor(Hypoglycaemia),
         `Loss of consciousness` = as.factor(`Loss of consciousness`),
         Diarrhoea = as.factor(Diarrhoea),
         Dizziness = as.factor(Dizziness),
         Shock = as.factor(Shock),
         Anorexia = as.factor(Anorexia),
         `Loss of axillary and pubic hair, if female` = as.factor(`Loss of axillary and pubic hair, if female`),
         `Any postural drop in blood pressure` = as.factor(`Any postural drop in blood pressure`)
         ) %>%
  dplyr::select(Vomiting, `Liking for salt`, Hypoglycaemia, `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, `Loss of axillary and pubic hair, if female`, `Any postural drop in blood pressure`, addisons_disease) %>%
tbl_summary(#signs_table2, 
            missing = "no",
            by = addisons_disease,
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  add_p() %>%
  add_n() %>%  
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

signs_table2
```

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

signs_table3 <- final_dataset %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10),
         `Presence of anaemia` = as.factor(`Presence of anaemia`),
         `Or, HIV viral load = LDL (choice=LDL)` = as.factor(`Or, HIV viral load = LDL (choice=LDL)`),
         `Current tuberculosis` = as.factor(`Current tuberculosis`),
         `Past tuberculosis` = as.factor(`Past tuberculosis`),
         `Electrolytes available` = as.factor(`Electrolytes available`)) %>%
  dplyr::select(`Presence of anaemia`, `log10 viral load`, `Or, HIV viral load = LDL (choice=LDL)`, `Current tuberculosis`, `Past tuberculosis`, `Electrolytes available`, Sodium, Potassium, Urea, addisons_disease) %>%
tbl_summary(#signs_table3, 
            missing = "no",
            by = addisons_disease,
            # label = list(`Total CD4 count...89` ~ 'Total CD4 count'
                         # ),
            statistic = list(all_continuous() ~ "{mean} ({sd})")
            ) %>% 
  add_p() %>%
  add_n() %>%  
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

signs_table3
```

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

signs_table4 <- final_dataset %>%
  mutate(#`log10 viral load` = log(`HIV viral load`, 10),
    `Full blood count (FBC) result available` = as.factor(`Full blood count (FBC) result available`),
    `Differential on FBC available` = as.factor(`Differential on FBC available`),
    `Aetiology of anaemia` = as.factor(`Aetiology of anaemia`)
    ) %>%
  dplyr::select(Creatinine, `Full blood count (FBC) result available`, Haemoglobin, `White cell count`, Platelets, MCV, `Differential on FBC available`, Neutrophils, `Lymphocyte count`, Eosinophils, Basophils, `Aetiology of anaemia`, addisons_disease) %>% #, `Other, specify...112`
tbl_summary(#signs_table4, 
            missing = "no",
            by = addisons_disease,
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  add_p() %>%
  add_n() %>%  
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

signs_table4
```

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

# outcome_variables <- final_dataset %>%
#   mutate(`Random cortisol result coded` = cut(`Random cortisol result`, breaks = c(80,500,1400)),
#          `ACTH result coded` = cut(`ACTH result`, breaks = c(0, 13.9, 500))
#          ) %>%
#   dplyr::select(`Random cortisol result`, `Random cortisol result coded`, `ACTH result`, `ACTH result coded`, `Antibodies sample drawn`, `Confirm random cortisol < 500 nmol/L`, `Confirm patient not on steroids for past 3 months`, `Synacthen: 0 minute cortisol result`, `Synacthen: 30 minute cortisol result`, addisons_disease) %>%
# tbl_summary(outcome_variables, missing = "no") %>% 
#   modify_header(label = "Variable") %>% # update the column header
#   bold_labels()

ctscan <- final_dataset %>%
  mutate(`CT scan done` = as.factor(`CT scan done`),
         Nodularity = as.factor(Nodularity),
         `Bilateral adrenal enlargement` = as.factor(`Bilateral adrenal enlargement`),
         `Calcification` = as.factor(`Calcification`),
         Atrophy = as.factor(Atrophy),
         Haemorrhage = as.factor(Haemorrhage),
         `Outcome of hospitalization` = as.factor(`Outcome of hospitalization`)) %>%
  dplyr::select(`CT scan done`, `Bilateral adrenal enlargement`, `Calcification`, Atrophy, Haemorrhage, Nodularity, `Outcome of hospitalization`, addisons_disease) %>%
tbl_summary(#ctscan, 
            missing = "no",
            by = addisons_disease,
            statistic = list(all_continuous() ~ "{mean} ({sd})")) %>% 
  add_p() %>%
  add_n() %>%  
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

ctscan
```

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

follow_up <- final_dataset %>%
  mutate(`3 followup_done` = as.factor(`3 followup_done`),
         `3 followup_patientstatus` = as.factor(`3 followup_patientstatus`),
         `3 followup_patientcondition` = as.factor(`3 followup_patientcondition`),
         `6 followup_done` = as.factor(`6 followup_done`),
         `6 followup_patientstatus` = as.factor(`6 followup_patientstatus`),
         `6 followup_patientcondition` = as.factor(`6 followup_patientcondition`),
         `12 followup_done` = as.factor(`12 followup_done`),
         `12 followup_patientstatus` = as.factor(`12 followup_patientstatus`),
         `12 followup_patientcondition` = as.factor(`12 followup_patientcondition`),
         `If deceased, cause of death` = as.factor(`If deceased, cause of death`)
         ) %>%
  dplyr::select( `3 followup_done`, `3 followup_patientstatus`, `3 followup_patientcondition`, `6 followup_done`, `6 followup_patientstatus`, `6 followup_patientcondition`, `12 followup_done`, `12 followup_patientstatus`, `12 followup_patientcondition`, `If deceased, cause of death`, addisons_disease) %>%
tbl_summary(#follow_up, 
  missing = "no",
  by = addisons_disease) %>% 
  add_p() %>%
  add_n() %>%  
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()
follow_up
```


```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
had_TB <- "TB"
dt01_1 <- dt01 %>%
  # left_join(dt02, by = 'Hospital folder number') %>%
  mutate(primary_med_condition_TB = ifelse(`Primary medical conditions`=='TB. IRIS' | `Primary medical conditions`=='TB Iris', FALSE, ifelse(`Primary medical conditions`=='MDR', TRUE,grepl(had_TB, `Primary medical conditions`, fixed = TRUE)))) %>%
  group_by(`Hospital folder number`) %>%
  mutate(tuberculosis = max(as.numeric(primary_med_condition_TB)),
         n_primary_med_conditions = as.factor(max(1:length(`Hospital folder number`)))
         ) %>%
  distinct(`Hospital folder number`, .keep_all = T) %>%
  dplyr::select(`Hospital folder number`, tuberculosis,n_primary_med_conditions)
dt02_1 <- dt02 %>%
  # left_join(dt02, by = 'Hospital folder number') %>%
  mutate(Coexisting_medical_conditions_TB = #ifelse(`Co-existing medical conditions`=='TB. IRIS' | `Co-existing medical conditions` =='TB Iris', FALSE, 
           grepl(had_TB, `Co-existing medical conditions`, fixed = TRUE)) %>%
  group_by(`Hospital folder number`) %>%
  mutate(tuberculosis_2 = max(as.numeric(Coexisting_medical_conditions_TB)),
         n_Coexisting_medical_conditions = as.factor(max(1:length(`Hospital folder number`)))
         ) %>%
  distinct(`Hospital folder number`, .keep_all = T) %>%
  dplyr::select(`Hospital folder number`, tuberculosis_2, n_Coexisting_medical_conditions)
dt03 <- dt01_1 %>%
  full_join(dt02_1, by = 'Hospital folder number') %>%
  dplyr::select(`Hospital folder number`, n_primary_med_conditions, n_Coexisting_medical_conditions,)
#GSH 169528 056 Sputum Genexpert
# coexisting medical condition: some have previous TB listed there
# GSH 45810 215, GSH 36510 881, GSH 19111 418, GSH 33987 033, GSH 115257 891

table_mortality <- final_dataset %>%
  dplyr::select(`Hospital folder number`, `3 followup_patientstatus`, `6 followup_patientstatus`, `12 followup_patientstatus`) %>%
  pivot_longer(cols = c(`3 followup_patientstatus`, `6 followup_patientstatus`, `12 followup_patientstatus`),
               names_to = 'col_num',
               values_to = 'followup_patientstatus') %>%
  dplyr::select(`Hospital folder number`, `followup_patientstatus`) %>%
  group_by(`Hospital folder number`) %>%
  mutate(mortality = ifelse(followup_patientstatus == 'Deceased --> EXIT form', 1,ifelse(followup_patientstatus == 'Alive', 0, 0))) %>%
  dplyr::select(`Hospital folder number`, mortality)
  table_mortality[is.na(table_mortality)] <- 0
table_mortality1 <- table_mortality %>% 
  group_by(`Hospital folder number`) %>%
  mutate(mortality = max(mortality)) %>%
  distinct(`Hospital folder number`, .keep_all = T) 

table_4data <- final_dataset %>%
  left_join(table_mortality1, by = 'Hospital folder number') %>%
  mutate(addisons_disease_advanced_HIV = ifelse(addisons_disease==1 & `CD4 < 100`==1 & `Oral or inhaled steroids in the last three months`=='No', 1, 0)) %>%
  mutate(HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
         enrol = as.Date(`Date of enrolment in study`, format = '%m/%d/%Y'),
         diagnosed = as.Date(`HIV, when diagnosed`, format = '%m/%d/%Y')) %>%
  dplyr::select(`Hospital folder number`, Ethnicity, Gender, `Total CD4 count...9`, `Random cortisol result`, `Synacthen: 30 minute cortisol result`, `Synacthen: 0 minute cortisol result`, `ACTH result`, Neutrophils, `Lymphocyte count`, Haemoglobin, Sodium, Hypoglycaemia, `BP (systolic)`, `BP (diastolic)`, `Current tuberculosis`, `Duration of current illness`, HIV_duration, addisons_disease_advanced_HIV, mortality) %>%
  left_join(dt03, by = 'Hospital folder number')

```

# Table 4 (Mortality): Predictors of recurrent admission, mortality, including basal cortisol, stimulated cortisol, incremental cortisol
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_4Adata_1 <- table_4data %>%
  dplyr::select(Ethnicity, Gender, `Total CD4 count...9`, `Random cortisol result`, `Synacthen: 30 minute cortisol result`, `Synacthen: 0 minute cortisol result`, `ACTH result`, Neutrophils, `Lymphocyte count`, Haemoglobin, mortality) %>%
tbl_summary(#clinical, 
            missing = "no",
            by = mortality,
            statistic = list(all_continuous() ~ "{mean} ({sd})"),
            label = list(`Total CD4 count...9` ~ 'Total CD4 count')
            ) %>% 
  add_p() %>%
  add_n() %>%  
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

table_4Adata_1

```

# Table 4 (Mortality): Predictors of recurrent admission, mortality, including basal cortisol, stimulated cortisol, incremental cortisol - continued
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_4Adata_2 <- table_4data %>%
  dplyr::select(Sodium, Hypoglycaemia, `BP (systolic)`, `BP (diastolic)`, `Current tuberculosis`, `Duration of current illness`, HIV_duration, n_primary_med_conditions, n_Coexisting_medical_conditions, addisons_disease_advanced_HIV, mortality) %>%
tbl_summary( 
            missing = "no",
            by = mortality,
            statistic = list(all_continuous() ~ "{mean} ({sd})")#,
            # label = list(`Total CD4 count...9` ~ 'Total CD4 count')
            ) %>% 
  add_p() %>%
  add_n() %>%  
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()

table_4Adata_2

```

# Table 6: Multivariate logistical regression analysis, examining the variables independently predictive of a poor outcome
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='hide'}
new_dataset <- table_4data %>%
  mutate(Ethnicity = as.numeric(as.factor(Ethnicity)),
         Gender = as.numeric(as.factor(Gender)),
         Hypoglycaemia = as.numeric(as.factor(Hypoglycaemia)),
         `Current tuberculosis` = as.numeric(as.factor(`Current tuberculosis`)),
         n_primary_med_conditions = as.numeric(n_primary_med_conditions),
         n_Coexisting_medical_conditions = as.numeric(n_Coexisting_medical_conditions),
         `Total CD4 count` = `Total CD4 count...9`
         ) %>%
  dplyr::select(-`Hospital folder number`, -`Total CD4 count...9`)
nr_imputations <- 5
imputedData <- mice::mice(data = data.frame(new_dataset), m = nr_imputations, maxit = 20, meth = 'pmm', seed = 33)
completeData <- complete(imputedData, 2)
# correlationMatrix <- cor(completeData)
# highlyCorrelated <- findCorrelation(correlationMatrix)
# print(highlyCorrelated)

model_dataset <- completeData
```


```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
control <- rfeControl(functions = rfFuncs, # random forest
                      method = "cv", # repeated cvrepeated
                      # repeats = 3, # number of repeats
                      number = 5) # number of folds
set.seed(33)
results <- rfe(model_dataset[,1:17,19:20], model_dataset[[18]], sizes = c(1:5), rfeControl = control)
var_selected <- predictors(results)

finalmodel_dataset <- model_dataset %>%
  # mutate(outcome = as.factor(utcome))%>%
  dplyr::select(mortality, addisons_disease_advanced_HIV, var_selected)

train_control <- trainControl(method = "cv", number = 5, #repeats = 100,
                              savePredictions = T) #repeated
set.seed(33)
model <- train(mortality ~ .,
  data = finalmodel_dataset,
  trControl = train_control,
  method = "glm",
  family = binomial()
)
# sjPlot::tab_model(model, show.icc = FALSE, show.re.var = FALSE)
final_table <- data.frame(exp(ci(model$finalModel)[2:4,1:3])) %>%
  mutate(Variable = c("Addison's disease advanced HIV", "Lymphocyte count", "BP diastolic")) %>%
  dplyr::select(Variable, Estimate, CI.lower, CI.upper)
row.names(final_table) <- 1:length(final_table$Variable)
write.csv(final_table, 'final_table.csv') 

```
