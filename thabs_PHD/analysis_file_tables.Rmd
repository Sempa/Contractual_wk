---
title: "Addison's disease associated with advanced HIV may explain the high mortality"
author: "Dr Joseph B Sempa"
date: "`r Sys.Date()`"
output:
  word_document:
    fig_caption: yes
    toc: yes
  pdf_document:
    fig_caption: yes
    toc: yes
  html_document:
    fig_caption: yes
    toc: yes
  html_notebook:
    toc: yes
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(results = 'asis')
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(magrittr)
library(knitr)
library(kableExtra)
library(tinytex)
library(gmodels)
library(readxl)
# library(MASS)
library(gtsummary)
library(caret)
library(leaps)
library(MASS)
library(predtools)
library(randomForest)
library(mice)
library(psfmi)
library(survival)
library(ranger)
library(ggplot2)
library(dplyr)
library(ggfortify)
library(survminer)
```


```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
final_dataset <- read_csv("final_dataset.csv", show_col_types = F) %>%
  mutate(addisons_disease = ifelse(`Random cortisol result` < 500 & (`Synacthen: 30 minute cortisol result`< 550 & `ACTH result`> 13.9), 1, 0)) #%>%
# dat <- final_dataset %>%
# dplyr::select(`Hospital folder number`,`Random cortisol result`, `ACTH sample drawn`, `ACTH result`, `Synacthen: 0 minute cortisol result`, `Synacthen: 30 minute cortisol result`, addisons_disease)
# write.csv(dat, 'outcome_dat.csv')
final_dataset<- final_dataset%>%
  mutate(Ethnicity = as.factor(Ethnicity))
contrasts(final_dataset$Ethnicity) <- 
  contr.treatment(levels(final_dataset$Ethnicity),                                                    base = which(levels(final_dataset$Ethnicity) == 'Black African'))
```

# Table 1
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_1 <- final_dataset %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10),
         HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
         gender = factor(Gender, labels = c('Females', 'Males')),
         `Addisons disease`  = as.factor(ifelse(addisons_disease ==1, 'yes', ifelse(addisons_disease ==0, 'no', '')))) %>%
  mutate(
    `Tuberculosis` = as.factor(`Opportunistic infection  (choice=Tuberculosis)`),
    `Cryptococcus neoformans` = as.factor(`Opportunistic infection  (choice=Cryptococcus neoformans)`),
    `Toxoplasmosis` = as.factor(`Opportunistic infection  (choice=Toxoplasmosis)`),
    `Mycobacterium avium-intracellulare` = as.factor(`Opportunistic infection  (choice=Mycobacterium avium-intracellulare)`),
    `Kaposis sarcoma` = as.factor(`Opportunistic infection  (choice=Kaposis sarcoma)`),
    `Cytomegalovirus` = as.factor(`Opportunistic infection  (choice=Cytomegalovirus)`),
    `Other` = as.factor(`Opportunistic infection  (choice=Other)`)
  ) %>%
  dplyr::select(`Age at enrolment`, gender, Ethnicity, `Duration of current illness`, `Opportunistic infection present`, `log10 viral load`, `Total CD4 count...9`, Sodium, Potassium, Haemoglobin, `White cell count`, `Lymphocyte count`, Neutrophils, `Addisons disease`, `Tuberculosis`, `Cryptococcus neoformans`, `Toxoplasmosis`, `Mycobacterium avium-intracellulare`, `Kaposis sarcoma`, `Cytomegalovirus`, `Other`) %>%
tbl_summary(#table_1,
            missing = "no",
            by = gender,
            # statistic = list(all_continuous() ~ "{mean} ({sd})"),
            digits = list(all_categorical() ~ c(0, 1)),
            label = list(`Total CD4 count...9` ~ 'Total CD4 count')
            ) %>%
  add_p() %>%
  add_n() %>%
  add_overall() %>%
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()
table_1

```

# Table 2: comparing Addisons status with other variables
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

table_2 <- final_dataset %>%
  mutate(Ethnicity = as.character(Ethnicity)) %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10),
         HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
         gender = factor(Gender, labels = c('Females', 'Males')),
         `Addisons disease`  = as.factor(ifelse(addisons_disease ==1, 'yes', ifelse(addisons_disease ==0, 'no', ''))),
         Ethnicity = ifelse(Ethnicity== 'Asian' | Ethnicity== 'Coloured' | Ethnicity== 'White', 'Other', Ethnicity)) %>%
  dplyr::select(`Age at enrolment, median (IQR) (years)` = `Age at enrolment`, `Gender, n(%)` = gender, `Ethnicity, n(%)` = Ethnicity, `Duration of current illness, median (IQR) (days)` = `Duration of current illness`, `Presence of an opportunistic infection` = `Opportunistic infection present`, `Viral load (log10 Copies/mL)` = `log10 viral load`, `Total CD4 count...9`, `Sodium mmol/L` = Sodium, `Potassium mmol/L` = Potassium, `Haemoglobin g/dL` = Haemoglobin, `White cell count X109` = `White cell count`, `Lymphocyte count X109` = `Lymphocyte count`, Neutrophils, `Addisons disease`) %>%
  mutate(`Addisons disease` = forcats::fct_rev(`Addisons disease`)) %>%
tbl_summary(#table_1,
            missing = "no",
            by = `Addisons disease`,
            # statistic = list(all_continuous() ~ "{mean} ({sd})"),
            digits = list(all_categorical() ~ c(0, 1)),
            label = list(`Total CD4 count...9` ~ 'Total CD4 count')
            ) %>%
  add_p() %>%
  add_n() %>%
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()
table_2

```

# Table 3: Bivariate table

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_mortality <- final_dataset %>%
  dplyr::select(`Hospital folder number`, `3 followup_patientstatus`, `6 followup_patientstatus`, `12 followup_patientstatus`) %>%
  pivot_longer(cols = c(`3 followup_patientstatus`, `6 followup_patientstatus`, `12 followup_patientstatus`),
               names_to = 'col_num',
               values_to = 'followup_patientstatus') %>%
  dplyr::select(`Hospital folder number`, `followup_patientstatus`) %>%
  group_by(`Hospital folder number`) %>%
  mutate(mortality = ifelse(followup_patientstatus == 'Deceased --> EXIT form', 1,ifelse(followup_patientstatus == 'Alive', 0, 0))) %>%
  dplyr::select(`Hospital folder number`, mortality)
table_mortality[is.na(table_mortality)] <- 0
table_mortality1 <- table_mortality %>% 
  group_by(`Hospital folder number`) %>%
  mutate(mortality = max(mortality)) %>%
  distinct(`Hospital folder number`, .keep_all = T) 

time_to_death <- final_dataset%>%
  dplyr::select(`Hospital folder number`, `3 followup_patientstatus`, 
                `6 followup_patientstatus`, `12 followup_patientstatus`
                ) %>%
  mutate(flag1 = ifelse(`3 followup_patientstatus` == "Deceased --> EXIT form", 3, NA),
         flag2 = ifelse(`6 followup_patientstatus` == "Deceased --> EXIT form", 6, NA),
         flag3 = ifelse(`12 followup_patientstatus` == "Deceased --> EXIT form", 12, NA)) %>%
  dplyr::select(`Hospital folder number`, flag1:flag3) %>%
  pivot_longer(cols = c(flag1:flag3),
               names_to = 'col_num',
               values_to = 'time to death') %>%
  dplyr::select(`Hospital folder number`, `time to death`) %>%
  group_by(`Hospital folder number`) %>%
  mutate(ttdeath = min(`time to death`, na.rm = T)) %>%
  ungroup() %>%
  mutate(ttdeath = ifelse(is.infinite(ttdeath), 12, ttdeath)) %>%
  distinct(`Hospital folder number`, .keep_all = T) %>%
    dplyr::select(`Hospital folder number`, ttdeath)
  
table_mortality1 <- table_mortality1 %>%
  left_join(time_to_death, by = 'Hospital folder number')

table_3 <- final_dataset %>%
  left_join(table_mortality1, by = 'Hospital folder number') %>%
  mutate(Ethnicity = as.character(Ethnicity)) %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10),
         HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
         gender = factor(Gender, labels = c('Females', 'Males')),
         `Addisons disease`  = as.factor(ifelse(addisons_disease ==1, 'yes', ifelse(addisons_disease ==0, 'no', ''))),
         Ethnicity = ifelse(Ethnicity== 'Asian' | Ethnicity== 'Coloured' | Ethnicity== 'White', 'Other', Ethnicity),
         `Total CD4 count` = `Total CD4 count...9`) %>%
  dplyr::select(`Age at enrolment`, gender, Ethnicity, `Duration of current illness`, `log10 viral load`, `Total CD4 count`, Sodium, Potassium, Haemoglobin, `White cell count`, `Lymphocyte count`, Neutrophils, `Addisons disease`, mortality, ttdeath) %>%
  mutate(Ethnicity = as.numeric(as.factor(Ethnicity)),
         gender = as.numeric(as.factor(gender)),
         Addisons_disease = as.numeric(as.factor(`Addisons disease`)),
         Log10_viralload = `log10 viral load`,
         Age_at_enrolment = `Age at enrolment`,
         Total_CD4_count = `Total CD4 count`,
         White_cell_count = `White cell count`,
         Lymphocyte_count = `Lymphocyte count`,
         Duration_of_current_illness = `Duration of current illness`) %>%
  dplyr::select(Age_at_enrolment, gender, Ethnicity, Duration_of_current_illness, Log10_viralload, Total_CD4_count, Sodium, Potassium, Haemoglobin, White_cell_count, Lymphocyte_count, Neutrophils, Addisons_disease, mortality, ttdeath)

tbl_uvregression(
  table_3,
  method=coxph,
  y = Surv(time = ttdeath, event = mortality),
  exponentiate = TRUE#,
  # include = -ID
)
```


```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
# nr_imputations <- 5
# imputedData <- mice::mice(data = data.frame(table_3), m = nr_imputations, maxit = 20, meth = 'pmm', seed = 33)
# completeData <- complete(imputedData, 2)
# correlationMatrix <- cor(completeData)
# highlyCorrelated <- findCorrelation(correlationMatrix)
# print(highlyCorrelated)

# model_dataset <- completeData
# tbl_uvregression(
#   model_dataset, #table_3,
#   method=coxph,
#   y = Surv(time = ttdeath, event = mortality),
#   exponentiate = TRUE#,
#   # include = -ID
# )
```

# Table 4: Multivariate table

The rule of thumb for MV models such as this on you need at least 10 people per outcome. We have 53 people with the outcome, yet we have 6 variables adjusted for in the model (using stepwise regression). I suggest we remove one variable from the list that you think may not be biologically contributing in the relationship. (see accompanying file)

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
nr_imputations <- 5
imputedData <- mice::mice(data = data.frame(table_3), m = nr_imputations, maxit = 20, meth = 'pmm', seed = 33)

scope <- list(upper = ~ Age_at_enrolment + gender + Ethnicity+ Duration_of_current_illness + Log10_viralload + Total_CD4_count+ Sodium + Potassium + Haemoglobin + White_cell_count + Lymphocyte_count+ Neutrophils + Addisons_disease,
              lower = ~1)
expr <- expression(f1 <- coxph(Surv(ttdeath, mortality) ~ 1),
                   f2 <- step(f1, scope = scope))
fit <- with(data = imputedData, expr)

formulas <- lapply(fit$analyses, formula)
terms <- lapply(formulas, terms)
votes <- unlist(lapply(terms, labels))
table(votes)

# model1 <- survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Neutrophils + Lymphocyte_count + Potassium, data = model_dataset) # + gender

model1 <- summary(pool(with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Lymphocyte_count + Potassium + Ethnicity))))
model2 <- summary(pool(with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Lymphocyte_count + Potassium + gender))))
# summary(model1)
# coef(model1)
# confint(model1)
final_model_table <- cbind(variable = model2[1], adj_HR = round(exp(model2[2]), 3), l_ci = round(exp(model2[2] - 1.96 * model2[3]), 4), u_ci = round(exp(model2[2] + 1.96 * model2[3]), 4), round(model2[6], 5))
names(final_model_table) <- c('variable', 'Adj_HR', 'Lower_CI', 'upper_CI', 'P value')
# mv_table <- #data.frame(
#   cbind(exp(cbind(coef(model1),confint(model1))), p_value = round(summary(model1)$coefficients[,5], 4))
#   #)
# final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)), summary(model1)$coefficients[, 5])) %>%
#   mutate(Variable = c("Addison's disease", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium'), Adj.HR = round(V1,3), `95%CI` = paste('(', round(`X2.5..`, 5), ', ', round(`X97.5..`, 5), ')', sep = ''), `P value` = V4) %>% #, 'gender'
#   dplyr::select(Variable, Adj.HR, `95%CI`, `P value`)
# row.names(final_table) <- 1:length(final_table$Variable)
write.csv(final_model_table, 'final_table_updated_ver 2.csv')
```
