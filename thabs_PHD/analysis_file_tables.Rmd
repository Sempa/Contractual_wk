---
title: "Addison's disease associated with advanced HIV may explain the high mortality"
author: "Dr Joseph B Sempa"
date: "`r Sys.Date()`"
output:
  word_document:
    fig_caption: yes
    toc: yes
  pdf_document:
    fig_caption: yes
    toc: yes
  html_document:
    fig_caption: yes
    toc: yes
  html_notebook:
    toc: yes
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)
knitr::opts_chunk$set(fig.pos = 'H')
knitr::opts_chunk$set(results = 'asis')
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
library(tidyverse)
library(magrittr)
library(knitr)
library(kableExtra)
library(tinytex)
library(gmodels)
library(readxl)
# library(MASS)
library(gtsummary)
library(caret)
library(leaps)
library(MASS)
library(predtools)
library(randomForest)
library(mice)
library(psfmi)
library(survival)
library(ranger)
library(ggplot2)
library(dplyr)
library(ggfortify)
library(survminer)
```


```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
final_dataset <- read_csv("final_dataset.csv", show_col_types = F) %>%
  mutate(addisons_disease = ifelse((`Random cortisol result` < 200 | `Synacthen: 30 minute cortisol result`< 500), 1, 0),
         PAI = ifelse((`Random cortisol result` < 200 | `Synacthen: 30 minute cortisol result`< 500) & `ACTH result`>= 64.6, 1, 0),
         SAI = ifelse(((`Random cortisol result` < 200 | `Synacthen: 30 minute cortisol result`< 500) & `ACTH result`< 64.6), 1, 0),
         total_AI = ifelse((PAI == 1 | SAI == 1) & `Random cortisol result` < 200, '<200', ifelse((PAI == 1 | SAI == 1) & `Synacthen: 30 minute cortisol result` < 500, '<500', NA))
           ) %>%
  mutate(AI = ifelse(PAI == 1, 'PAI', ifelse(SAI == 1, 'SAI', '')))
# dat <- final_dataset %>%
# dplyr::select(`Hospital folder number`,`Random cortisol result`, `ACTH sample drawn`, `ACTH result`, `Synacthen: 0 minute cortisol result`, `Synacthen: 30 minute cortisol result`, addisons_disease)
# write.csv(dat, 'outcome_dat.csv')
final_dataset<- final_dataset%>%
  mutate(Ethnicity = as.factor(Ethnicity))
contrasts(final_dataset$Ethnicity) <- 
  contr.treatment(levels(final_dataset$Ethnicity),                                                   
                  base = which(levels(final_dataset$Ethnicity) == 'Black African'))
```

# Table 1
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_1 <- final_dataset %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10),
         HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
         gender = factor(Gender, labels = c('Females', 'Males')),
         `Addisons disease`  = as.factor(ifelse(addisons_disease ==1, 'yes', ifelse(addisons_disease ==0, 'no', '')))) %>%
  mutate(
    `Tuberculosis` = as.factor(`Opportunistic infection  (choice=Tuberculosis)`),
    `Cryptococcus neoformans` = as.factor(`Opportunistic infection  (choice=Cryptococcus neoformans)`),
    `Toxoplasmosis` = as.factor(`Opportunistic infection  (choice=Toxoplasmosis)`),
    `Mycobacterium avium-intracellulare` = as.factor(`Opportunistic infection  (choice=Mycobacterium avium-intracellulare)`),
    `Kaposis sarcoma` = as.factor(`Opportunistic infection  (choice=Kaposis sarcoma)`),
    `Cytomegalovirus` = as.factor(`Opportunistic infection  (choice=Cytomegalovirus)`),
    `Other` = as.factor(`Opportunistic infection  (choice=Other)`)
  ) %>%
  dplyr::select(`Age at enrolment`, gender, Ethnicity, `Duration of current illness`, `Opportunistic infection present`, `log10 viral load`, `Total CD4 count...9`, Sodium, Potassium, Haemoglobin, `White cell count`, `Lymphocyte count`, Neutrophils, `Addisons disease`, `Tuberculosis`, `Cryptococcus neoformans`, `Toxoplasmosis`, `Mycobacterium avium-intracellulare`, `Kaposis sarcoma`, `Cytomegalovirus`, `Other`) %>%
tbl_summary(#table_1,
            missing = "no",
            by = gender,
            # statistic = list(all_continuous() ~ "{mean} ({sd})"),
            digits = list(all_categorical() ~ c(0, 1)),
            label = list(`Total CD4 count...9` ~ 'Total CD4 count')
            ) %>%
  add_p() %>%
  add_n() %>%
  add_overall() %>%
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()
table_1

```

# Table 1.2
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_12 <- final_dataset %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10),
         HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
         gender = factor(Gender, labels = c('Females', 'Males')),
         `Addisons disease`  = as.factor(ifelse(addisons_disease ==1, 'yes', ifelse(addisons_disease ==0, 'no', '')))) %>%
  mutate(
    `Tuberculosis` = as.factor(`Opportunistic infection  (choice=Tuberculosis)`),
    `Cryptococcus neoformans` = as.factor(`Opportunistic infection  (choice=Cryptococcus neoformans)`),
    `Toxoplasmosis` = as.factor(`Opportunistic infection  (choice=Toxoplasmosis)`),
    `Mycobacterium avium-intracellulare` = as.factor(`Opportunistic infection  (choice=Mycobacterium avium-intracellulare)`),
    `Kaposis sarcoma` = as.factor(`Opportunistic infection  (choice=Kaposis sarcoma)`),
    `Cytomegalovirus` = as.factor(`Opportunistic infection  (choice=Cytomegalovirus)`),
    `Other` = as.factor(`Opportunistic infection  (choice=Other)`)
  ) %>%
  mutate(`CD4 counts` = case_when(
    `Total CD4 count...9` <= 30 ~ '0 - 30',
    `Total CD4 count...9` >30 & `Total CD4 count...9`<=60 ~ '31 - 60',
    `Total CD4 count...9` > 60 & `Total CD4 count...9` <= 100 ~ '61 - 100'
  )) %>%
  dplyr::select(`Age at enrolment`, gender, Ethnicity, `Duration of current illness`, #`Opportunistic infection present`,  Sodium, Potassium, Haemoglobin, `White cell count`, `Lymphocyte count`, Neutrophils, `Addisons disease`, `Tuberculosis`, `Cryptococcus neoformans`, `Toxoplasmosis`, `Mycobacterium avium-intracellulare`, `Kaposis sarcoma`, `Cytomegalovirus`, `Other`,
                Tiredness, Weakness, `Poor appetite`, `Weight loss`, Nausea, Vomiting, Diarrhoea, `Liking for salt`, Dizziness, `Loss of consciousness`, 
                Hypoglycaemia, Hypotension, `BP (systolic)`, `BP (diastolic)`, `Any postural drop in blood pressure`,
                Shock, Anorexia, `Loss of axillary and pubic hair, if female`, `Increased pigmentation of the skin`, 
                
                `Presence of anaemia`, `Haemoglobin g/dL` = Haemoglobin, `Presence of an opportunistic infection` = `Opportunistic infection present`, `White cell count X109` = `White cell count`, `Lymphocyte count X109` = `Lymphocyte count`,  Neutrophils, `log10 viral load`, `Sodium mmol/L` = Sodium, `Potassium mmol/L` = Potassium, `Random cortisol` = `Random cortisol result`, `Basal cortisol` = `Synacthen: 0 minute cortisol result`, `Stimulated cortisol` = `Synacthen: 30 minute cortisol result`, `ACTH` = `ACTH result`, `CD4 counts`,#`Addisons disease`,
                `Tuberculosis`, `Cryptococcus neoformans`, `Mycobacterium avium-intracellulare`,`Toxoplasmosis`,
                `Cytomegalovirus`, `Kaposis sarcoma`, `Other`) %>%# , 
tbl_summary(#table_1,
            missing = "no",
            by = `CD4 counts`,
            # statistic = list(all_continuous() ~ "{mean} ({sd})"),
            digits = list(all_categorical() ~ c(0, 1))#,
            # label = list(`Total CD4 count...9` ~ 'Total CD4 count')
            ) %>%
  add_p() %>%
  add_n() %>%
  add_overall() %>%
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()
table_12

```


# Table 2: comparing Addisons status with other variables
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

table_2 <- final_dataset %>%
  mutate(Ethnicity = as.character(Ethnicity)) %>%
  mutate(
    `log10 viral load` = log(`HIV viral load`, 10),
    HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format = "%m/%d/%Y") - as.Date(`HIV, when diagnosed`, format = "%m/%d/%Y")),
    gender = factor(Gender, labels = c("Females", "Males")),
    `Addisons disease` = as.factor(ifelse(addisons_disease == 1, "yes", ifelse(addisons_disease == 0, "no", ""))),
    Ethnicity = ifelse(Ethnicity == "Asian" | Ethnicity == "Coloured" | Ethnicity == "White", "Other", Ethnicity),
  ) %>%
  filter(AI != "") %>%
  dplyr::select(`Age at enrolment, median (IQR) (years)` = `Age at enrolment`, `Gender, n(%)` = gender, `Ethnicity, n(%)` = Ethnicity, `Duration of current illness, median (IQR) (days)` = `Duration of current illness`, `Random cortisol` = `Random cortisol result`, `Basal cortisol` = `Synacthen: 0 minute cortisol result`, `Stimulated cortisol` = `Synacthen: 30 minute cortisol result`, `ACTH` = `ACTH result`, `BP (systolic)`, `BP (diastolic)`, `Heart rate`, Hypotension, Weakness, Tiredness, `Poor appetite`, `Weight loss`, `Increased pigmentation of the skin`, Nausea, Vomiting, `Liking for salt`, Hypoglycaemia, `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, `Loss of axillary and pubic hair, if female`, `Any postural drop in blood pressure`, `Presence of anaemia`, `Presence of an opportunistic infection` = `Opportunistic infection present`, `Viral load (log10 Copies/mL)` = `log10 viral load`, `Total CD4 count...9`, `Sodium mmol/L` = Sodium, `Potassium mmol/L` = Potassium, `Haemoglobin g/dL` = Haemoglobin, `White cell count X109` = `White cell count`, `Lymphocyte count X109` = `Lymphocyte count`, Neutrophils, `3 followup_patientstatus`, `6 followup_patientstatus`, `12 followup_patientstatus`, `Addisons disease`) %>%
  mutate(`Addisons disease` = forcats::fct_rev(`Addisons disease`)) %>%
  tbl_summary( # table_1,
    missing = "no",
    by = `Addisons disease`,
    # statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(all_categorical() ~ c(0, 1)),
    label = list(`Total CD4 count...9` ~ "Total CD4 count")
  ) %>%
  add_p() %>%
  add_n() %>%
  add_overall() %>%
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()
table_2
```

## cross-tabulation
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_2_1 <- final_dataset %>%
  mutate(Ethnicity = as.character(Ethnicity)) %>%
  mutate(
    `log10 viral load` = log(`HIV viral load`, 10),
    HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format = "%m/%d/%Y") - as.Date(`HIV, when diagnosed`, format = "%m/%d/%Y")),
    gender = factor(Gender, labels = c("Females", "Males")),
    `Addisons disease` = as.factor(ifelse(addisons_disease == 1, "yes", ifelse(addisons_disease == 0, "no", ""))),
    Ethnicity = ifelse(Ethnicity == "Asian" | Ethnicity == "Coloured" | Ethnicity == "White", "Other", Ethnicity),
  ) %>%
  filter(AI != '') %>%
  dplyr::select(`Age at enrolment, median (IQR) (years)` = `Age at enrolment`, 
    `Gender, n(%)` = gender, `Ethnicity, n(%)` = Ethnicity, `Duration of current illness, median (IQR) (days)` = `Duration of current illness`, `Random cortisol` = `Random cortisol result`, `Basal cortisol` = `Synacthen: 0 minute cortisol result`, `Stimulated cortisol` = `Synacthen: 30 minute cortisol result`, `ACTH` = `ACTH result`, `BP (systolic)`, `BP (diastolic)`, `Heart rate`, Hypotension, Weakness, Tiredness, `Poor appetite`, `Weight loss`, `Increased pigmentation of the skin`, Nausea, Vomiting, `Liking for salt`, Hypoglycaemia, `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, `Loss of axillary and pubic hair, if female`, `Any postural drop in blood pressure`, `Presence of anaemia`, `Presence of an opportunistic infection` = `Opportunistic infection present`, `Viral load (log10 Copies/mL)` = `log10 viral load`, `CD4 count` = `Total CD4 count...9`, `Sodium mmol/L` = Sodium, `Potassium mmol/L` = Potassium, `Haemoglobin g/dL` = Haemoglobin, `White cell count X109` = `White cell count`, `Lymphocyte count X109` = `Lymphocyte count`, Neutrophils, `3 followup_patientstatus`, `6 followup_patientstatus`, `12 followup_patientstatus`, `AI`#, `total AI` = total_AI
                ) %>%
        tbl_summary( # table_1,
          missing = "no",
          by = `AI`,
          type = list(c("Duration of current illness, median (IQR) (days)", "Random cortisol", "Basal cortisol", "Stimulated cortisol", "ACTH", "BP (systolic)", "BP (diastolic)", "Potassium mmol/L", "Age at enrolment, median (IQR) (years)", "Viral load (log10 Copies/mL)", "CD4 count", "White cell count X109", "Haemoglobin g/dL", "Sodium mmol/L", "Heart rate", "Lymphocyte count X109", "Neutrophils") ~ "continuous"),#
          statistic = list(all_continuous() ~ "{median} ({p25}, {p75})"),
          digits = list(all_categorical() ~ c(0, 1))
        ) %>%
        add_p() %>%
        add_overall() %>%
        modify_header(label = "Variable") %>% # update the column header
        bold_labels()

table_2_1

table_2_2 <- final_dataset %>%
  mutate(Ethnicity = as.character(Ethnicity),
         AI_recoded = ifelse(AI %in% c('PAI', 'SAI'), 'AI', 'No-AI')) %>%
  mutate(
    `log10 viral load` = log(`HIV viral load`, 10),
    HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format = "%m/%d/%Y") - as.Date(`HIV, when diagnosed`, format = "%m/%d/%Y")),
    gender = factor(Gender, labels = c("Females", "Males")),
    `Addisons disease` = as.factor(ifelse(addisons_disease == 1, "yes", ifelse(addisons_disease == 0, "no", ""))),
    Ethnicity = ifelse(Ethnicity == "Asian" | Ethnicity == "Coloured" | Ethnicity == "White", "Other", Ethnicity),
  ) %>%
  dplyr::select(`Age at enrolment, median (IQR) (years)` = `Age at enrolment`, 
    `Gender, n(%)` = gender, `Ethnicity, n(%)` = Ethnicity, `Duration of current illness, median (IQR) (days)` = `Duration of current illness`, `Random cortisol` = `Random cortisol result`, `Basal cortisol` = `Synacthen: 0 minute cortisol result`, `Stimulated cortisol` = `Synacthen: 30 minute cortisol result`, `ACTH` = `ACTH result`, `BP (systolic)`, `BP (diastolic)`, `Heart rate`, Hypotension, Weakness, Tiredness, `Poor appetite`, `Weight loss`, `Increased pigmentation of the skin`, Nausea, Vomiting, `Liking for salt`, Hypoglycaemia, `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, `Loss of axillary and pubic hair, if female`, `Any postural drop in blood pressure`, `Presence of anaemia`, `Presence of an opportunistic infection` = `Opportunistic infection present`, `Viral load (log10 Copies/mL)` = `log10 viral load`, `CD4 count` = `Total CD4 count...9`, `Sodium mmol/L` = Sodium, `Potassium mmol/L` = Potassium, `Haemoglobin g/dL` = Haemoglobin, `White cell count X109` = `White cell count`, `Lymphocyte count X109` = `Lymphocyte count`, Neutrophils, `3 followup_patientstatus`, `6 followup_patientstatus`, `12 followup_patientstatus`, AI_recoded#, `total AI` = total_AI
                ) %>%
        tbl_summary( # table_1,
          missing = "no",
          by = `AI_recoded`,
          type = list(c("Duration of current illness, median (IQR) (days)", "Random cortisol", "Basal cortisol", "Stimulated cortisol", "ACTH", "BP (systolic)", "BP (diastolic)", "Potassium mmol/L", "Age at enrolment, median (IQR) (years)", "Viral load (log10 Copies/mL)", "CD4 count", "White cell count X109", "Haemoglobin g/dL", "Sodium mmol/L", "Heart rate", "Lymphocyte count X109", "Neutrophils") ~ "continuous"),#
          statistic = list(all_continuous() ~ "{median} ({p25}, {p75})"),
          digits = list(all_categorical() ~ c(0, 1))
        ) %>%
        add_p() %>%
        add_overall() %>%
        modify_header(label = "Variable") %>% # update the column header
        bold_labels()

table_2_2

# table_2_3 <- tbl_merge(list(table_2_1, table_2_2))
# table_2_3
```

## extra table
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_2_1 <- final_dataset %>%
  filter(`Loss of axillary and pubic hair, if female` != "Not applicable") %>%
  mutate(Ethnicity = as.character(Ethnicity)) %>%
  mutate(
    `log10 viral load` = log(`HIV viral load`, 10),
    HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format = "%m/%d/%Y") - as.Date(`HIV, when diagnosed`, format = "%m/%d/%Y")),
    gender = factor(Gender, labels = c("Females", "Males")),
    `Addisons disease` = as.factor(ifelse(addisons_disease == 1, "yes", ifelse(addisons_disease == 0, "no", ""))),
    Ethnicity = ifelse(Ethnicity == "Asian" | Ethnicity == "Coloured" | Ethnicity == "White", "Other", Ethnicity)
  ) %>%
  dplyr::select(`Loss of axillary and pubic hair, if female`, `Addisons disease`) %>%
  mutate(`Addisons disease` = forcats::fct_rev(`Addisons disease`)) %>%
  tbl_summary( # table_1,
    missing = "no",
    by = `Addisons disease`,
    # statistic = list(all_continuous() ~ "{mean} ({sd})"),
    digits = list(all_categorical() ~ c(0, 1)) # ,
    # label = list(`Total CD4 count...9` ~ 'Total CD4 count')
  ) %>%
  add_p() %>%
  add_n() %>%
  modify_header(label = "Variable") %>% # update the column header
  bold_labels()
table_2_1


```

# Table 3: Bivariate table

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_mortality <- final_dataset %>%
  dplyr::select(`Hospital folder number`, `3 followup_patientstatus`, `6 followup_patientstatus`, `12 followup_patientstatus`) %>%
  pivot_longer(cols = c(`3 followup_patientstatus`, `6 followup_patientstatus`, `12 followup_patientstatus`),
               names_to = 'col_num',
               values_to = 'followup_patientstatus') %>%
  dplyr::select(`Hospital folder number`, `followup_patientstatus`) %>%
  group_by(`Hospital folder number`) %>%
  mutate(mortality = ifelse(followup_patientstatus == 'Deceased --> EXIT form', 1,ifelse(followup_patientstatus == 'Alive', 0, 0))) %>%
  dplyr::select(`Hospital folder number`, mortality)
table_mortality[is.na(table_mortality)] <- 0
table_mortality1 <- table_mortality %>%
  group_by(`Hospital folder number`) %>%
  mutate(mortality = max(mortality)) %>%
  distinct(`Hospital folder number`, .keep_all = T)

time_to_death <- final_dataset%>%
  dplyr::select(`Hospital folder number`, `3 followup_patientstatus`,
                `6 followup_patientstatus`, `12 followup_patientstatus`
                ) %>%
  mutate(flag1 = ifelse(`3 followup_patientstatus` == "Deceased --> EXIT form", 3, NA),
         flag2 = ifelse(`6 followup_patientstatus` == "Deceased --> EXIT form", 6, NA),
         flag3 = ifelse(`12 followup_patientstatus` == "Deceased --> EXIT form", 12, NA)) %>%
  dplyr::select(`Hospital folder number`, flag1:flag3) %>%
  pivot_longer(cols = c(flag1:flag3),
               names_to = 'col_num',
               values_to = 'time to death') %>%
  dplyr::select(`Hospital folder number`, `time to death`) %>%
  group_by(`Hospital folder number`) %>%
  mutate(ttdeath = min(`time to death`, na.rm = T)) %>%
  ungroup() %>%
  mutate(ttdeath = ifelse(is.infinite(ttdeath), 12, ttdeath)) %>%
  distinct(`Hospital folder number`, .keep_all = T) %>%
    dplyr::select(`Hospital folder number`, ttdeath)

interval_deaths <- final_dataset%>%
  dplyr::select(`Hospital folder number`, `3 followup_patientstatus`,
                `6 followup_patientstatus`, `12 followup_patientstatus`
                ) %>%
  mutate(flag1 = ifelse(`3 followup_patientstatus` == "Deceased --> EXIT form", 3, NA),
         flag2 = ifelse(`6 followup_patientstatus` == "Deceased --> EXIT form", 6, NA),
         flag3 = ifelse(`12 followup_patientstatus` == "Deceased --> EXIT form", 12, NA)) %>%
  dplyr::select(`Hospital folder number`, flag1:flag3) %>%
  pivot_longer(cols = c(flag1:flag3),
               names_to = 'col_num',
               values_to = 'time to death') %>%
  dplyr::select(`Hospital folder number`, `time to death`) %>%
  group_by(`Hospital folder number`) %>%
  mutate(ttdeath = min(`time to death`, na.rm = T)) %>%
  ungroup()
x <- interval_deaths %>% filter(!is.na(`time to death`))%>% distinct(`Hospital folder number`, .keep_all = T)
# table(x$ttdeath)

table_mortality1 <- table_mortality1 %>%
  left_join(time_to_death, by = 'Hospital folder number')

table_3 <- final_dataset %>%
  left_join(table_mortality1, by = 'Hospital folder number') %>%
  mutate(Ethnicity = as.character(Ethnicity)) %>%
  mutate(`log10 viral load` = log(`HIV viral load`, 10),
         HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
         gender = factor(Gender, labels = c('Females', 'Males')),
         `Addisons disease`  = as.factor(ifelse(addisons_disease ==1, 'yes', ifelse(addisons_disease ==0, 'no', ''))),
         Ethnicity = ifelse(Ethnicity== 'Asian' | Ethnicity== 'Coloured' | Ethnicity== 'White', 'Other', Ethnicity),
         `Total CD4 count` = `Total CD4 count...9`,
         discharged = ifelse(!is.na(`Date of discharge`), 'Yes', 'No')
         ) %>%
  mutate(
    `Tuberculosis` = as.factor(`Opportunistic infection  (choice=Tuberculosis)`),
    `Cryptococcus neoformans` = as.factor(`Opportunistic infection  (choice=Cryptococcus neoformans)`),
    `Toxoplasmosis` = as.factor(`Opportunistic infection  (choice=Toxoplasmosis)`),
    `Mycobacterium avium-intracellulare` = as.factor(`Opportunistic infection  (choice=Mycobacterium avium-intracellulare)`),
    `Kaposis sarcoma` = as.factor(`Opportunistic infection  (choice=Kaposis sarcoma)`),
    `Cytomegalovirus` = as.factor(`Opportunistic infection  (choice=Cytomegalovirus)`),
    `Other` = as.factor(`Opportunistic infection  (choice=Other)`)
  ) %>%
  dplyr::select(`Age at enrolment`, gender, Ethnicity, `Duration of current illness`, `log10 viral load`, `Total CD4 count`, Sodium, Potassium, Haemoglobin, `White cell count`, `Lymphocyte count`, Neutrophils, `Addisons disease`, mortality, ttdeath, `Random cortisol result`, `Synacthen: 0 minute cortisol result`, `Synacthen: 30 minute cortisol result`, `ACTH result`, `BP (systolic)`, `BP (diastolic)`, discharged,
                `Heart rate`, Hypotension, Weakness, Tiredness, `Poor appetite`, `Weight loss`, `Increased pigmentation of the skin`, Nausea, Vomiting, `Liking for salt`, Hypoglycaemia, `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, `Loss of axillary and pubic hair, if female`, `Any postural drop in blood pressure`, `Presence of anaemia`, `Presence of an opportunistic infection` = `Opportunistic infection present`, `Tuberculosis`, `Cryptococcus neoformans`, `Toxoplasmosis`,`Mycobacterium avium-intracellulare`,
                `Kaposis sarcoma`, `Cytomegalovirus`, `Other`, `Date of enrolment in study`, `HIV, when diagnosed`) %>%
  mutate(Ethnicity = as.numeric(as.factor(Ethnicity)),
         gender = as.numeric(as.factor(gender)),
         Addisons_disease = as.numeric(as.factor(`Addisons disease`)),
         Log10_viralload = `log10 viral load`,
         Age_at_enrolment = `Age at enrolment`,
         Total_CD4_count = `Total CD4 count`,
         White_cell_count = `White cell count`,
         Lymphocyte_count = `Lymphocyte count`,
         Duration_of_current_illness = `Duration of current illness`) %>%
  dplyr::select(Age_at_enrolment, gender, Ethnicity, Duration_of_current_illness, `Viral load (log10 Copies/mL)` = Log10_viralload, `CD4 count` = Total_CD4_count, Sodium, `Potassium mmol/L` = Potassium, Haemoglobin, White_cell_count, Lymphocyte_count, Neutrophils, Addisons_disease, mortality, ttdeath,
                `Random cortisol` = `Random cortisol result`, `Basal cortisol` = `Synacthen: 0 minute cortisol result`, `Stimulated cortisol` = `Synacthen: 30 minute cortisol result`, `ACTH` = `ACTH result`, `BP (systolic)`, `BP (diastolic)`, `Addisons disease`, discharged, `Heart rate`, Hypotension, Weakness, Tiredness, `Poor appetite`, `Weight loss`, `Increased pigmentation of the skin`, Nausea, Vomiting, `Liking for salt`, Hypoglycaemia, `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, `Loss of axillary and pubic hair, if female`, `Any postural drop in blood pressure`, `Presence of anaemia`, `Presence of an opportunistic infection`, `Tuberculosis`, `Cryptococcus neoformans`, `Toxoplasmosis`,`Mycobacterium avium-intracellulare`,
                `Kaposis sarcoma`, `Cytomegalovirus`, `Other`, `Date of enrolment in study`, `HIV, when diagnosed`)

# tbl_uvregression(
#   table_3,
#   method=coxph,
#   y = Surv(time = ttdeath, event = mortality),
#   exponentiate = TRUE#,
#   # include = -ID
# )
interval_deaths_addissons <- interval_deaths %>% filter(!is.na(`time to death`))%>% distinct(`Hospital folder number`, .keep_all = T) %>% filter(`Hospital folder number` %in% c('GSH 167073 154', 'GSH 170759 435', 'GSH 70197 710', 'GSH 79071 908', 'GSH 83628 503'))
```


# Table 3a: Deep dive on Addison's disease patients

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_4 <- table_3 %>%
  filter(mortality == 1) %>%
  mutate(Ethnicity = as.character(Ethnicity)) %>%
  mutate(HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
         gender = factor(gender, labels = c('Females', 'Males')),
         Ethnicity = ifelse(Ethnicity== 'Asian' | Ethnicity== 'Coloured' | Ethnicity== 'White', 'Other', Ethnicity),
         ) %>%
  dplyr::select(`Age at enrolment median (IQR) (years)` = Age_at_enrolment, `Gender, n(%)` = gender, `Ethnicity, n(%)` = Ethnicity, `Duration of current illness, median (IQR) (days)` = HIV_duration, `Random cortisol`, `Basal cortisol`, `Stimulated cortisol`, `ACTH`, `BP (systolic)`, `BP (diastolic)`, `Heart rate`, Hypotension, Weakness, Tiredness, `Poor appetite`, `Weight loss`, `Increased pigmentation of the skin`, Nausea, Vomiting, `Liking for salt`, Hypoglycaemia, `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, `Loss of axillary and pubic hair, if female`, `Any postural drop in blood pressure`, `Presence of anaemia`, `Presence of an opportunistic infection`, `Tuberculosis`, `Cryptococcus neoformans`, `Toxoplasmosis`,`Mycobacterium avium-intracellulare`,
                `Kaposis sarcoma`, `Cytomegalovirus`, `Other`, `Viral load (log10 Copies/mL)`, `Total CD4 count` = `CD4 count`, `Sodium mmol/L` = Sodium, `Potassium mmol/L`, `Haemoglobin g/dL` = Haemoglobin, `White cell count X109` = White_cell_count, `Lymphocyte count X109` = Lymphocyte_count, `Addisons disease`) %>%
  mutate(`Addisons disease` = forcats::fct_rev(`Addisons disease`)) %>%
tbl_summary(#table_1,
            missing = "no",
            by = `Addisons disease`,
            digits = list(all_categorical() ~ c(0, 1)),
            ) %>%
  add_p() %>%
  add_n() %>%
  modify_header(label = "Variable") %>%
  bold_labels() %>%
  modify_footnote(everything() ~ NA)
table_4
```

# Table 3b: Deep dive in mortality status among Addissons cases
```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_4_1 <- table_3 %>%
  # filter(mortality == 1) %>%
  filter(`Addisons disease` == "yes") %>%
  mutate(Ethnicity = as.character(Ethnicity)) %>%
  mutate(HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
    `mortality with Addisons disease` = ifelse(mortality == 1, 'yes', 'no'),
    gender = factor(gender, labels = c("Females", "Males")),
    Ethnicity = ifelse(Ethnicity == "Asian" | Ethnicity == "Coloured" | Ethnicity == "White", "Other", Ethnicity)
  ) %>%
  dplyr::select(`mortality with Addisons disease`, `Age at enrolment median (IQR) (years)` = Age_at_enrolment, `Gender, n(%)` = gender, `Ethnicity, n(%)` = Ethnicity, `Duration of current illness, median (IQR) (days)` = HIV_duration, `Random cortisol`, `Basal cortisol`, `Stimulated cortisol`, `ACTH`, `BP (systolic)`, `BP (diastolic)`, `Heart rate`, Hypotension, Weakness, Tiredness, `Poor appetite`, `Weight loss`, `Increased pigmentation of the skin`, Nausea, Vomiting, `Liking for salt`, Hypoglycaemia, `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, `Loss of axillary and pubic hair, if female`, `Any postural drop in blood pressure`, `Presence of anaemia`, `Presence of an opportunistic infection`, `Tuberculosis`, `Cryptococcus neoformans`, `Toxoplasmosis`,`Mycobacterium avium-intracellulare`,
                `Kaposis sarcoma`, `Cytomegalovirus`, `Other`, `Viral load (log10 Copies/mL)`, `Total CD4 count` = `CD4 count`, `Sodium mmol/L` = Sodium, `Potassium mmol/L`, `Haemoglobin g/dL` = Haemoglobin, `White cell count X109` = White_cell_count, `Lymphocyte count X109` = Lymphocyte_count, `Addisons disease`) %>%
  mutate(`mortality with Addisons disease` = forcats::fct_rev(`mortality with Addisons disease`)) %>%
  tbl_summary( # table_1,
    missing = "no",
    by = `mortality with Addisons disease`,
    # type = list(c("Random cortisol", "Basal cortisol", "Stimulated cortisol", "ACTH", "BP (systolic)", "BP (diastolic)", "Potassium mmol/L", "Viral load (log10 Copies/mL)", "CD4 count") ~ "continuous"),
    digits = list(all_categorical() ~ c(0, 1)),
  ) %>%
  add_p() %>%
  add_n() %>%
modify_header(label = "Variable") %>%
bold_labels() %>%
modify_footnote(everything() ~ NA)

table_4_1

```



```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
# nr_imputations <- 5
# imputedData <- mice::mice(data = data.frame(table_3), m = nr_imputations, maxit = 20, meth = 'pmm', seed = 33)
# completeData <- complete(imputedData, 2)
# correlationMatrix <- cor(completeData)
# highlyCorrelated <- findCorrelation(correlationMatrix)
# print(highlyCorrelated)

# model_dataset <- completeData
tbl_uvregression(
  table_3 %>%
  mutate(Ethnicity = as.character(Ethnicity)) %>%
  mutate(HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
    `mortality with Addisons disease` = ifelse(mortality == 1, 'yes', 'no'),
    gender = factor(gender, labels = c("Females", "Males")),
    Ethnicity = ifelse(Ethnicity == "Asian" | Ethnicity == "Coloured" | Ethnicity == "White", "Other", Ethnicity)
  ) %>%
  dplyr::select(Age_at_enrolment, gender, Ethnicity, HIV_duration, Random_cortisol = `Random cortisol`, Basal_cortisol = `Basal cortisol`, Stimulated_cortisol = `Stimulated cortisol`, `ACTH`, BP_systolic = `BP (systolic)`, BP_diastolic = `BP (diastolic)`, Heart_rate = `Heart rate`, Hypotension, Weakness, Tiredness, Poor_appetite = `Poor appetite`, Weight_loss = `Weight loss`, Increased_pigmentation_of_the_skin = `Increased pigmentation of the skin`, Nausea, Vomiting,  Liking_for_salt = `Liking for salt`, Hypoglycaemia, Loss_of_consciousness = `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, Loss_of_axillary_and_pubic_hair = `Loss of axillary and pubic hair, if female`, Any_postural_drop_in_blood_pressure = `Any postural drop in blood pressure`, Presence_of_anaemia = `Presence of anaemia`, #Presence_of_an_opportunistic_infection = `Presence of an opportunistic infection`,
                `Tuberculosis`, #Cryptococcus_neoformans = `Cryptococcus neoformans`,
                #`Toxoplasmosis`, Mycobacterium_avium_intracellulare = `Mycobacterium avium-intracellulare`,
                Kaposis_sarcoma = `Kaposis sarcoma`, `Cytomegalovirus`, `Other`, Viral_load = `Viral load (log10 Copies/mL)`, CD4_count = `CD4 count`, Sodium, Potassium = `Potassium mmol/L`,  Haemoglobin, White_cell_count, Lymphocyte_count,
                Addisons_disease = `Addisons disease`, ttdeath, mortality), #table_3,
  method=coxph,
  y = Surv(time = ttdeath, event = mortality),
  exponentiate = TRUE#,
  # include = -ID
)
```

# Table 4: Multivariate table mortality

The rule of thumb for MV models such as this on you need at least 10 people per outcome. We have 53 people with the outcome, yet we have 6 variables adjusted for in the model (using stepwise regression). I suggest we remove one variable from the list that you think may not be biologically contributing in the relationship. (see accompanying file)

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
nr_imputations <- 5
imputedData <- mice::mice(data = data.frame(table_3), m = nr_imputations, maxit = 20, meth = 'pmm', seed = 33)

scope <- list(upper = ~ Age_at_enrolment + gender + Ethnicity+ Duration_of_current_illness + Viral.load..log10.Copies.mL. + CD4.count+ Sodium + Potassium.mmol.L + Haemoglobin + White_cell_count + Lymphocyte_count+ Neutrophils + Addisons_disease,
              lower = ~1)
expr <- expression(f1 <- coxph(Surv(ttdeath, mortality) ~ 1),
                   f2 <- step(f1, scope = scope))
fit <- with(data = imputedData, expr)

formulas <- lapply(fit$analyses, formula)
terms <- lapply(formulas, terms)
votes <- unlist(lapply(terms, labels))
table(votes)

# model1 <- survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Neutrophils + Lymphocyte_count + Potassium, data = model_dataset) # + gender

model1 <- pool(with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Viral.load..log10.Copies.mL. + Lymphocyte_count + Potassium.mmol.L + Age_at_enrolment)))#Ethnicity
# model2 <- summary(pool(with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Lymphocyte_count + Potassium + gender))))
summary(model1, conf.int = TRUE)
# coef(model1)
# confint(model1)
# final_model_table <- cbind(variable = model2[1], adj_HR = round(exp(model2[2]), 3), l_ci = round(exp(model2[2] - 1.96 * model2[3]), 4), u_ci = round(exp(model2[2] + 1.96 * model2[3]), 4), round(model2[6], 5))
# names(final_model_table) <- c('variable', 'Adj_HR', 'Lower_CI', 'upper_CI', 'P value')
# mv_table <- #data.frame(
#   cbind(exp(cbind(coef(model1),confint(model1))), p_value = round(summary(model1)$coefficients[,5], 4))
#   #)
# final_table <- data.frame(cbind(exp(coef(model1)), exp(confint(model1)), summary(model1)$coefficients[, 5])) %>%
#   mutate(Variable = c("Addison's disease", "Log10 Viral load", 'Neutrophils', 'Lymphocyte count', 'Potassium'), Adj.HR = round(V1,3), `95%CI` = paste('(', round(`X2.5..`, 5), ', ', round(`X97.5..`, 5), ')', sep = ''), `P value` = V4) %>% #, 'gender'
  # dplyr::select(Variable, Adj.HR, `95%CI`, `P value`)
# row.names(final_table) <- 1:length(final_table$Variable)
# write.csv(final_model_table, 'final_table_updated_ver 2.csv')
model_dataset <- complete(imputedData, 2)
km_fit <- survival::survfit(Surv(ttdeath, mortality) ~ Addisons,
  data = model_dataset %>%
  mutate(Addisons = as.factor(ifelse(Addisons_disease == 1, "Yes", "No")))
)
jpeg('KM_curve.jpeg', width = 480, height = 480, units = 'px', pointsize = 14, quality = 75, bg = 'white')
survminer::ggsurvplot(km_fit,
  conf.int = TRUE,
  risk.table.col = "strata", # Change risk table color by groups
  ggtheme = theme_bw(), # Change ggplot2 theme
  palette = c("#E7B800", "#2E9FDF"),
  xlim = c(0, 12.5)
)
dev.off()
```


# Table 5 univariate analysis for addisson's disease

```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}

table_5 <- table_3 %>%
  mutate(Ethnicity = as.character(Ethnicity)) %>%
  mutate(HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
    `mortality with Addisons disease` = ifelse(mortality == 1, 'yes', 'no'),
    gender = factor(gender, labels = c("Females", "Males")),
    Ethnicity = ifelse(Ethnicity == "Asian" | Ethnicity == "Coloured" | Ethnicity == "White", "Other", Ethnicity)
  ) %>%
  dplyr::select(Age_at_enrolment, gender, Ethnicity, HIV_duration, Random_cortisol = `Random cortisol`, Basal_cortisol = `Basal cortisol`, Stimulated_cortisol = `Stimulated cortisol`, `ACTH`, BP_systolic = `BP (systolic)`, BP_diastolic = `BP (diastolic)`, Heart_rate = `Heart rate`, Hypotension, Weakness, Tiredness, Poor_appetite = `Poor appetite`, Weight_loss = `Weight loss`, Increased_pigmentation_of_the_skin = `Increased pigmentation of the skin`, Nausea, Vomiting,  Liking_for_salt = `Liking for salt`, Hypoglycaemia, Loss_of_consciousness = `Loss of consciousness`, Diarrhoea, Dizziness, Shock, Anorexia, Loss_of_axillary_and_pubic_hair = `Loss of axillary and pubic hair, if female`, Any_postural_drop_in_blood_pressure = `Any postural drop in blood pressure`, Presence_of_anaemia = `Presence of anaemia`, #Presence_of_an_opportunistic_infection = `Presence of an opportunistic infection`,
                `Tuberculosis`, #Cryptococcus_neoformans = `Cryptococcus neoformans`,
                #`Toxoplasmosis`, Mycobacterium_avium_intracellulare = `Mycobacterium avium-intracellulare`,
                Kaposis_sarcoma = `Kaposis sarcoma`, `Cytomegalovirus`, `Other`, Viral_load = `Viral load (log10 Copies/mL)`, CD4_count = `CD4 count`, Sodium, Potassium = `Potassium mmol/L`,  Haemoglobin, White_cell_count, Lymphocyte_count,
                Addisons_disease = `Addisons disease`) #%>%
# tbl_uvregression(
#   table_5,
#     # trial[c("Addisons_disease", "gender", "Age_at_enrolment")],
#     method = glm,
#     y = Addisons_disease,
#     method.args = list(family = binomial),
#     exponentiate = TRUE
#   )

```



```{r, message = FALSE, cache = TRUE, warning=FALSE, echo = FALSE, results='asis'}
table_6 <- table_3 %>%
  mutate(Ethnicity = as.character(Ethnicity)) %>%
  mutate(HIV_duration = as.numeric(as.Date(`Date of enrolment in study`, format='%m/%d/%Y') - as.Date(`HIV, when diagnosed`, format='%m/%d/%Y')),
    `mortality with Addisons disease` = ifelse(mortality == 1, 'yes', 'no'),
    gender = factor(gender, labels = c("Females", "Males")),
    Ethnicity = ifelse(Ethnicity == "Asian" | Ethnicity == "Coloured" | Ethnicity == "White", "Other", Ethnicity)
  ) %>%
  dplyr::select(Random_cortisol = `Random cortisol`, Basal_cortisol = `Basal cortisol`, Stimulated_cortisol = `Stimulated cortisol`, `ACTH`, BP_diastolic = `BP (diastolic)`, Weakness, Diarrhoea, `Tuberculosis`, `Other`, Sodium,  Lymphocyte_count, Addisons_disease = `Addisons disease`) %>%
  filter(!is.na(Addisons_disease))
nr_imputations <- 5
imputedData <- mice::mice(data = data.frame(table_6), m = nr_imputations, maxit = 20, meth = 'pmm', seed = 33)
# completeData <- complete(imputedData, 1)
scope <- list(upper = ~ Random_cortisol + Basal_cortisol + Stimulated_cortisol + ACTH + BP_diastolic + #Weakness +
               # Diarrhoea +
                Tuberculosis + Other + Sodium + Lymphocyte_count,
              lower = ~ 1)
expr <- expression(f1 <- glm(Addisons_disease ~ 1, family = binomial(link = "logit")),
                   f2 <- step(f1, scope = scope))
fit <- with(data = imputedData, expr)

formulas <- lapply(fit$analyses, formula)
terms <- lapply(formulas, terms)
votes <- unlist(lapply(terms, labels))
table(votes)

model1 <- pool(with(data = imputedData, expr = glm(Addisons_disease ~ ACTH + Stimulated_cortisol, #BP_diastolic +
                                                 family = binomial(link = "logit"))))
                    #survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Viral.load..log10.Copies.mL. + Lymphocyte_count + Potassium.mmol.L + Age_at_enrolment)))#Ethnicity
# model2 <- summary(pool(with(data=imputedData, expr = survival::coxph(Surv(ttdeath, mortality) ~ Addisons_disease + Log10_viralload + Lymphocyte_count + Potassium + gender))))
summary(model1, conf.int = TRUE)

```

